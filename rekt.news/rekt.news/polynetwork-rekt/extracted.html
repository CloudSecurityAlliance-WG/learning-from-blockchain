<section class="post-content"><p><figure><img alt="" src="https://raw.githubusercontent.com/RektHQ/Assets/main/images/2021/08/poly-header.png"/></figure></p><p><strong>This is it rekt readers; the big one.</strong></p><p><em>$611 million dollars stolen.</em></p><p>That’s more than the <a href="https://www.bloomberg.com/news/articles/2014-02-28/mt-gox-exchange-files-for-bankruptcy">Mt Gox hack</a>. More than the GDP of several small countries. More than the entire rekt.news leaderboard added together.</p><p><strong>The biggest cryptocurrency hack... <em>ever</em>.</strong></p><blockquote><p><a href="https://twitter.com/PolyNetwork2/status/1425130017546149891">Poly Network</a> = rekt.</p></blockquote><p><em>But how?</em></p><p><figure><img alt="" src="https://raw.githubusercontent.com/RektHQ/Assets/main/images/2021/08/poly-investigates.png"/></figure></p><p><em>Credit:</em><a href="https://www.breadcrumbs.app/reports/671">breadcrumbs.app</a>, <a href="https://twitter.com/SlowMist_Team/status/1425197809058254849?s=20">slowmist</a>, <a href="https://blocksecteam.medium.com/the-initial-analysis-of-the-polynetwork-hack-270ac6072e2a">blocksec</a></p><p><strong>Attacker ETH:</strong> <a href="https://etherscan.io/address/0xc8a65fadf0e0ddaf421f28feab69bf6e2e589963">0xc8a65fadf0e0ddaf421f28feab69bf6e2e589963</a></p><p><strong>Attacker BSC:</strong> <a href="https://bscscan.com/address/0x0D6e286A7cfD25E0c01fEe9756765D8033B32C71">0x0D6e286A7cfD25E0c01fEe9756765D8033B32C71</a></p><p><strong>This was not the usual smart contract flash loan / arbitrage affair.</strong></p><p><strong>The hacker exploited the Proxy Lock Contracts of Poly Network on three different chains.</strong></p><p><strong>Ethereum:</strong><a href="https://etherscan.io/address/0x250e76987d838a75310c34bf422ea9f1ac4cc906">0x250e76987d838a75310c34bf422ea9f1ac4cc906</a></p><p><strong>BSC:</strong><a href="https://bscscan.com/address/0x05f0fDD0E49A5225011fff92aD85cC68e1D1F08e">0x05f0fDD0E49A5225011fff92aD85cC68e1D1F08e</a></p><p><strong>Polygon:</strong><a href="https://polygonscan.com/address/0x28FF66a1B95d7CAcf8eDED2e658f768F44841212">0x28FF66a1B95d7CAcf8eDED2e658f768F44841212</a></p><blockquote><p>Credit: <a href="https://twitter.com/kelvinfichter">@kelvinfichter</a></p></blockquote><p><strong>"Poly has a contract called the "<strong>EthCrossChainManager</strong>". It's a privileged contract that has the right to trigger messages from another chain. It's a standard thing for cross-chain projects.</strong></p><p>It has a function named <strong>verifyHeaderAndExecuteTx</strong> that anyone can call to execute a cross-chain transaction.</p><p>It (1) verifies that the block header is correct by checking signatures (seems the other chain was a poa sidechain or) and then (2) checks that the transaction was included within that block with a Merkle proof. <a href="https://github.com/polynetwork/eth-contracts/blob/d16252b2b857eecf8e558bd3e1f3bb14cff30e9b/contracts/core/cross_chain_manager/logic/EthCrossChainManager.sol#L127">Here's the code.</a></p><p>One of the last things the function does is call <strong>executeCrossChainTx</strong>, which makes the call to the target contract. This is where the critical flaw sits. <a href="https://github.com/polynetwork/eth-contracts/blob/d16252b2b857eecf8e558bd3e1f3bb14cff30e9b/contracts/core/cross_chain_manager/logic/EthCrossChainManager.sol#L185">Poly checks</a> that the target is a contract, but they forgot to prevent users from calling a very important target... the <a href="https://github.com/polynetwork/eth-contracts/blob/master/contracts/core/cross_chain_manager/data/EthCrossChainData.sol"><strong>EthCrossChainData</strong> contract</a></p><p>By sending this cross-chain message, the user could trick the <strong>EthCrossChainManager</strong> into calling the <strong>EthCrossChainData</strong> contract, passing the <strong>onlyOwner</strong> check. Now the user just had to craft the right data to be able to trigger the function that changes the public keys…</p><p>The only remaining challenge was to figure out how to make the <strong>EthCrossChainManager</strong> call the right function. Now comes a little bit of complexity around how Solidity picks which function you're trying to call.</p><p>The first four bytes of transaction input data is called the "signature hash" or "sighash" for short. It's a short piece of information that tells a Solidity contract what you're trying to do.</p><p>The sighash of a function is calculated by taking the first four bytes of the hash of "<!-- -->&lt;function name&gt;<!-- -->(<!-- -->&lt;function input types&gt;<!-- -->)". For example, the sighash of the ERC20 transfer function is the first four bytes of the hash of "transfer(address,uint256)".</p><p>Poly's contract was willing to call any contract. However, it would only call the contract function that corresponded to the following sighash:</p><p><figure><img alt="" src="https://raw.githubusercontent.com/RektHQ/Assets/main/images/2021/08/poly-sighash.png"/></figure></p><p>Errr but wait... <strong>"_method"</strong> here was user input. All the attacker had to do to call the right function was figure out <em>some</em> value for "<strong>_method</strong>" that, when combined with those other values and hashed, had the same leading four bytes as the sighash of our target function.</p><p>With just a little bit of grinding, you can easily find some input that produces the right sighash. You don't need to find a full hash collision, you're only checking the first four bytes. So is this theory correct?</p><p>Well... here's the actual sighash of the target function:</p><blockquote><p><a href="http://ethers.utils.id">http://ethers.utils.id</a> ('putCurEpochConPubKeyBytes(bytes)').slice(0, 10)</p></blockquote><p>'0x41973cd9'</p><p>And the sighash that the attacker crafted...</p><blockquote><p><a href="http://ethers.utils.id">http://ethers.utils.id</a> ('f1121318093(bytes,bytes,uint64)').slice(0, 10)</p></blockquote><p>'0x41973cd9'</p><p><strong>Fantastic. No private key compromise required! Just craft the right data and boom... the contract will just hack itself!</strong></p><p>One of the biggest design lessons that people need to take away from this is: if you have cross-chain relay contracts like this, <strong>MAKE SURE THAT THEY CAN'T BE USED TO CALL SPECIAL CONTRACTS.</strong> The <strong>EthCrossDomainManager</strong> shouldn't have owned the <strong>EthCrossDomainData</strong> contract.</p><p>Separate concerns. If your contract absolutely needs to have special privileges like this, make sure that users can't use cross-chain messages to call those special contracts."</p><p><figure><img alt="" src="https://raw.githubusercontent.com/RektHQ/Assets/main/images/2021/03/rekt-linebreak.png"/></figure></p><blockquote><p>On the Ethereum blockchain, the hacker stole</p></blockquote><p><strong>USDC</strong> - 96,389,444</p><p><strong>WBTC</strong> - 1,032</p><p><strong>DAI</strong> - 673,227</p><p><strong>UNI</strong> - 43,023</p><p><strong>SHIBA</strong> - 259,737,345,149</p><p><strong>renBTC</strong>- 14.47</p><p><strong>USDT</strong> - 33,431,197</p><p><strong>wETH</strong> - 26,109</p><p><strong>FEI USD</strong> - 616,082</p><blockquote><p>On BSC, the hacker stole:</p></blockquote><p><strong>BNB</strong> - 6,613.44</p><p><strong>USDC</strong> - 87,603,373</p><p><strong>ETH</strong> - 299</p><p><strong>BTCB</strong> - 26,629</p><p><strong>BUSD</strong> - 1,023</p><blockquote><p>On the Polygon blockchain, the hacker stole:</p></blockquote><p><strong>USDC</strong> - 85,089,610</p><blockquote><p>TOTAL VALUE LOST - ~$611,000,000</p></blockquote><p><em>At the time of writing, the stolen funds are located in the following wallets:</em></p><p><strong>ETH:</strong> <a href="https://etherscan.io/address/0xC8a65Fadf0e0dDAf421F28FEAb69Bf6E2E589963">0xC8a65Fadf0e0dDAf421F28FEAb69Bf6E2E589963</a></p><p><strong>BSC:</strong> <a href="https://bscscan.com/address/0x0D6e286A7cfD25E0c01fEe9756765D8033B32C71">0x0D6e286A7cfD25E0c01fEe9756765D8033B32C71</a></p><p><strong>Polygon:</strong> <a href="https://polygonscan.com/address/0x5dc3603C9D42Ff184153a8a9094a73d461663214">0x5dc3603C9D42Ff184153a8a9094a73d461663214</a></p><p><figure><img alt="" src="https://raw.githubusercontent.com/RektHQ/Assets/main/images/2021/03/rekt-linebreak.png"/></figure></p><p><strong>DeFi storylines are rarely straightforward, and this one is no exception.</strong></p><p><em>Even anonymous actors adore attention.</em></p><p>Shortly after the exploit, an unexpected protagonist appeared, going by the name of <a href="https://etherscan.io/address/0xf8b5c45c6388c9ee12546061786026aaeaa4b682">hanashiro.eth.</a></p><p>hanashiro.eth first gained attention when they <a href="https://etherscan.io/tx/0xae2442c5b5721df8c190fd8f59b53b6dc56a875fb03035ad34276a598ddf7d31">sent the hacker</a> a tip about how to handle USDT, for which they <a href="https://etherscan.io/tx/0xdf3afc47c7914e06ddb1be19afcd769e558111d353e55273a62c4a96e6a6090f">received 13.37 Ether</a> from the hacker as a reward.</p><p><strong><a href="https://twitter.com/JustDoingItBig/status/1425115724209655812?s=20">Many others</a> sent messages to the hacker afterwards, but none were quite as successful as hanashiro.eth.</strong></p><p>With a truly crypto native level of philanthropic showmanship, hanashiro.eth went on to donate their stolen money to a few of the foundational organisations which support our industry, such as Infura, Etherscan, and <a href="https://www.rekt.news/">rekt.news</a>.</p><p><em>But not all of the funds were so freely accessible.</em></p><p><a href="https://twitter.com/paoloardoino/status/1425090760609832978?s=20">Tether froze all of the 33M USDT</a> that were stolen on the Ethereum chain.</p><p><strong>Their coin - their choice… A fact worth remembering if you use USDT.</strong></p><p>By this point the shit had really hit the fan; and all eyes were on <a href="https://twitter.com/PolyNetwork2/status/1425123153009803267">Poly Network, who resorted to posting an open letter</a> to the attacker begging them to return the funds.</p><p><strong>A single tweet asking a criminal to return six hundred million dollars... Maybe Gensler was right when he said we are in the <a href="https://www.reuters.com/technology/us-sec-chair-gensler-calls-congress-help-rein-crypto-wild-west-2021-08-03/">“Wild West”</a> phase of cryptocurrency.</strong></p><p>Consider the mindset of the attacker at this point in the story. Which do you think they felt more; euphoria, or terror?</p><p><strong>Stealing 600 million dollars whilst sat at your computer must be a surreal experience.</strong></p><p><em>The experience of then trying to launder that money must be equally intense.</em></p><p>Aside from JPEGS, tornado.cash would be the obvious starting point, and that’s exactly where our hacker went.</p><p>They <a href="https://twitter.com/UnderTheBreach/status/1425119885978447875?s=20">sent themself a transaction</a> containing the message;</p><blockquote><p>Wonder why Tornado? Will miners stop me? Teach me please</p></blockquote><p><strong>Was that psyops or stupidity? In crypto it’s never quite clear...</strong></p><p><strong>On the run with 600 million, and broadcasting messages to an audience of thousands.</strong></p><p><em>The hacker was growing too confident.</em></p><p><figure><img alt="" src="https://raw.githubusercontent.com/RektHQ/Assets/main/images/2021/08/poly-fallout.png"/></figure></p><p><strong>When <a href="https://twitter.com/wardbradt/status/1425112492397764609?s=20">@WardBradt</a> tweeted the following;</strong></p><blockquote><p>Did the PolyNetwork Exploiter accidentally use the wrong sender address for this tx <a href="https://t.co/SXS7F6iJsM?amp=1">0xb12681d9e</a>? The sender address is tied to FTX, Binance, Okex accounts.</p></blockquote><p><strong>Suddenly the attacker's attitude changed.</strong></p><p>Surely a hacker who feels confident enough to attempt an attack of this scale wouldn’t make such a basic OPSEC error? Or maybe they used fake KYC documents…</p><p><em>Either way, we began to see signs of fear from the attacker.</em></p><p>The hacker <a href="https://twitter.com/UnderTheBreach/status/1425127303353356293?s=20">began to suggest</a> that they might return <em>"some tokens"</em> or even abandon them, saying that they were <em>"not so interested in the money".</em></p><p><a href="https://twitter.com/sniko_/status/1425135792658255877?s=20">Then the hacker considered the idea</a> of creating a DAO to distribute the stolen funds.</p><p><strong>Finally, the pressure became too much, and the hacker announced that they were <a href="https://etherscan.io/tx/0x7b6009ea08c868d7c5c336bf1bc30c33b87a0eedd59dac8c26e6a8551b20b68a">“READY TO SURRENDER”</a></strong></p><p><strong>In an unexpected and unprecedented move, the attacker is now returning the funds to Poly Network.</strong></p><p>They announced that they were <a href="https://etherscan.io/tx/0x7b6009ea08c868d7c5c336bf1bc30c33b87a0eedd59dac8c26e6a8551b20b68a">"READY TO RETURN THE FUNDS!"</a> in an Ethereum transaction that was sent from the same wallet used for the attack.</p><p>Before sending the first return transaction, the hacker created a token called "The hacker is ready to surrender" and sent this token to Poly Network who announced that they had set up a <a href="https://twitter.com/PolyNetwork2/status/1425321860539949056">multisig controlled by ‘’known Poly addresses’’</a>.</p><p><a href="https://docs.google.com/spreadsheets/u/1/d/11LUJwLoHX8ZCyfjhg5YZ0V99iU6PafMNL_NET45FSVc/htmlview?pru=AAABe1lDAS0*CdZKWo5WZNYwj5Qca8505A#gid=0">A summary of the hackers' communication with Poly Network can be found here.</a></p><p><strong>At the time of writing, the hacker has returned the following:</strong></p><p>On the Ethereum blockchain: <a href="https://etherscan.io/address/0x71fb9db587f6d47ac8192cd76110e05b8fd2142f#tokentxns">$2.6M</a></p><p>On the BSC: <a href="https://bscscan.com/address/0xEEBb0c4a5017bEd8079B88F35528eF2c722b31fc">$1.1M</a></p><p>On the Polygon blockchain: <a href="https://polygonscan.com/address/0xa4b291ed1220310d3120f515b5b7accaecd66f17">$1M</a></p><p><strong>Will the hacker continue to return the funds, or is this just another stunt?</strong></p><p><em>Can they really just return the money and be forgiven?</em></p><p><figure><img alt="" src="https://raw.githubusercontent.com/RektHQ/Assets/main/images/2021/03/rekt-linebreak.png"/></figure></p><p><strong>Poly Network. 611 million.</strong></p><p><em>And you thought you knew all the big protocols in DeFi.</em></p><p><strong>This industry has grown bigger than our echo chamber can handle.</strong></p><p>This may be the first, but it won’t be the last hack of this size that we will see over the coming years. Yet the market seems unfazed, and rightly so.</p><p>For <a href="https://finance.yahoo.com/news/coinbase-crushes-q2-expectations-notes-210643795.html">better</a> or for <a href="https://www.coindesk.com/bitmex-announces-100m-cftc-fincen-settlement">worse</a>, crypto will make the news, and the <a href="https://twitter.com/NeerajKA/status/1423721468123287556?s=20">world will have to take notice</a> as our industry becomes the norm.</p><p><em>This is just another inevitable part of the progress.</em></p><p><figure><img alt="" src="https://raw.githubusercontent.com/RektHQ/Assets/main/images/2021/08/poly-conc.png"/></figure></p>