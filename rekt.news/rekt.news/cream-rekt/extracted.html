<section class="post-content"><p><figure><img alt="" src="https://raw.githubusercontent.com/RektHQ/Assets/main/images/2021/08/cream-header.png"/></figure>
<strong>Inspector rekt back once again.</strong></p><p><em>$18.8M lost to a ghostface killer, this time from an old school DeFi protocol.</em></p><p><a href="https://twitter.com/peckshield/status/1432224092275548160?s=20">Cream Finance</a> was audited by <a href="https://docs.cream.finance/audit-report">Trail of Bits</a> (one of the few auditors absent from our <a href="https://www.rekt.news/leaderboard/">leaderboard</a>) on Jan 28th 2021.</p><p><strong>However, even the strongest audit becomes irrelevant once the protocol is changed.</strong></p><p>On Feb 10th 2021, the <a href="https://forum.cream.finance/t/proposal-add-amp-as-a-collateral-asset/387">Cream proposal</a> to add the <a href="https://twitter.com/CreamdotFinance/status/1359348996032974852?s=20">AMP token</a> came into effect, and the loophole opened up.</p><p><figure><img alt="" src="https://raw.githubusercontent.com/RektHQ/Assets/main/images/2021/08/cream-investigates.png"/></figure>
<em>Credit: <a href="https://twitter.com/peckshield/status/1432249600002478081">@peckshield</a></em></p><p>418,311,571 AMP tokens and 1,308.09 ETH were lost on the Cream Finance AMP token contract.</p><p>The AMP token contract implements ERC77-based ERC1820, which has the <strong>_callPreTransferHooks</strong> for reentrancy.</p><p>The reentrancy vulnerability within the <a href="https://etherscan.io/address/0xff20817765cb7f73d4bde2e66e067e58d11095c2#code">AMP token contract</a> allowed the exploiter to nest a second borrow() function inside the token transfer() before the initial borrow() has been updated:</p><p><figure><img alt="" src="https://raw.githubusercontent.com/RektHQ/Assets/main/images/2021/08/cream-reentry.png"/></figure>
<strong><a href="https://etherscan.io/tx/0xa9a1b8ea288eb9ad315088f17f7c7386b9989c95b4d13c81b69d5ddad7ffe61e">Example exploit transaction</a> (one of 17)</strong></p><p>Attack contracts: <a href="https://etherscan.io/address/0x38c40427efbaae566407e4cde2a91947df0bd22b">A</a>, <a href="https://etherscan.io/address/0x0ec306d7634314d35139d1df4a630d829475a125">B</a> and <a href="https://etherscan.io/address/0xce1f4b4f17224ec6df16eeb1e3e5321c54ff6ede">exploiter wallet</a>.</p><p>In the above example, the hacker:</p><p><strong>1:</strong> Uses contract A to take a flash loan of 500 WETH to use as collateral on Cream, minting 24.17k crETH</p><p><strong>2:</strong> Borrows 19.48M AMP against crETH</p><p><strong>3:</strong> Exploits the reentrancy bug by inserting a further borrow() function into the token transfer, taking a further 355 ETH before the initial borrow() has been updated.</p><p><strong>4:</strong> Creates contract B, which is funded with half (9.74M) of A’s borrowed AMP</p><p><strong>5:</strong> Contract B then liquidates part of A’s loan, redeeming 187 WETH and transferring it back to contract A.</p><p><strong>6:</strong> Contract A then uses the ETH borrowed via reentrancy to repay the remainder of the flashloan, leaving a surplus of 41 ETH and 9.74 AMP as profit for this transaction.</p><p>A similar process was used over 17 transactions, accumulating a total of almost 6k ETH.</p><p>At the time of writing, the stolen ETH (currently worth just over $18M) remains in the exploiter’s address: <a href="https://etherscan.io/address/0xce1f4b4f17224ec6df16eeb1e3e5321c54ff6ede">0xce1f4b4f17224ec6df16eeb1e3e5321c54ff6ede</a></p><p><figure><img alt="" src="https://raw.githubusercontent.com/RektHQ/Assets/main/images/2021/08/cream-parental-advisory-linebreak.png"/></figure>
<strong>Cream has never had a great reputation. Perhaps this is why many believed this to be their second or third time getting rekt</strong></p><p>Although they were involved with the <a href="https://rekt.news/alpha-finance-rekt/">Alpha Finance incident</a>, this is actually the first direct attack to hit Cream Finance.</p><p>Regardless of reputation, even time-tested protocols can be undermined by the <a href="https://www.youtube.com/watch?v=6GaCt_lM_ak">integration of a vulnerable token.</a></p><p>However, as @muditgupta pointed out;</p><blockquote><p>...seems like [Cream] would have been safe had they just added reentrancy protection on their borrow/lend function.</p></blockquote><p><em>Can it all be so simple?</em></p><p><figure><img alt="" src="https://raw.githubusercontent.com/RektHQ/Assets/main/images/2021/08/cream-conclusion.gif"/></figure></p>