<section class="post-content"><p><figure><img alt="" src="https://raw.githubusercontent.com/RektHQ/Assets/main/images/2023/01/orion-header.png"/></figure></p><p><em>The hunter has become the hunted.</em></p><p><strong><a href="https://www.orionprotocol.io/">Orion Protocol</a> fell prey to a reentrancy exploit on Thursday, losing a total of $3M on ETH and BSC.</strong></p><p>The project is a ‘liquidity aggregator’ aiming to bring CEX liquidity on-chain (not to be confused with Orion Finance who <a href="https://twitter.com/paladin_marco/status/1620822928228233222">rugged $320k</a> on Arbitrum the day before).</p><p>A few hours after the <a href="https://twitter.com/peckshield/status/1621178662396788736">news</a> <a href="https://twitter.com/spreekaway/status/1621181995387686918">spread</a> on Twitter, Orion’s CEO <a href="https://twitter.com/alexeykoloskov/status/1621269256401731591">announced</a> the loss, clarifying that the damage was contained to an internal broker account and that user funds remain safe.</p><p>Orion’s website states:</p><blockquote><p>WHY WE EXIST</p><p>No one has solved liquidity, custody, accessibility, and scalability in one platform.</p><p>Until now.</p></blockquote><p><em>Perhaps they should have added security to that list…</em></p><p><figure><img alt="" src="https://raw.githubusercontent.com/RektHQ/Assets/main/images/2021/09/rekt-investigates-linebreak.png"/></figure></p><p>Credit: <em><a href="https://twitter.com/SlowMist_Team/status/1621441874841206786">SlowMist</a>, <a href="https://twitter.com/peckshield/status/1621337925228306433">Peckshield</a></em></p><p><strong>The attacker used manipulated swaps of flash loaned stablecoins, artificially depositing the assets twice before withdrawing the inflated balance.</strong></p><p>By creating a fake token (ATK) and routing a swap of the flash loaned funds via ATK, a reentrancy hook called depositAsset within ATK’s transfer function, effectively doubling the attacker’s account balance.</p><p><em>Slowmist <a href="https://twitter.com/SlowMist_Team/status/1621441874841206786">provided</a> a detailed breakdown of the attack:</em></p><blockquote><p>The attacker first called the depositAsset function of the ExchangeWithAtomic contract to make a deposit of 0.5 USDC tokens in preparation for the following attack:</p><p>Next, the attacker makes a flashloan of 284,700 USDT and then calls the doSwapThroughOrionPool function of the ExchangeWithAtomic contract to swap the tokens, the exchange path is "USDC -&gt; ATK(malicious token created by the attacker) -&gt; USDT".</p><p>The out amount of the exchange is the USDT balance in the ExchangeWithAtomic contract after the exchange minus the initial balance of 2,844,700 USDT.</p><p>The problem arises when a call to the ATK token transfer function during the exchange causes the attacker to re-enter the ExchangeWithAtomic contract depositAsset function, resulting in the transfer of 284.4 million USDT from the flashloan to the ExchangeWithAtomic contract.</p><p>The attacker's deposit in the ExchangeWithAtomic contract is recorded as 2,844,700 and the balance of USDT tokens in the contract becomes 5,689,000. As a result, the attacker's exchange of USDT is calculated as 5,689,000 minus 2,844,700.</p><p>By calling the library function creditUserAssets to update the attacking contract's ledger in the ExchangeWithAtomic contract used the exchanged USDT, resulting in the attacking contract's final deposit of USDT in the ExchangeWithAtomic contract being recorded as 5.68 million.</p><p>Finally, the attacker withdraws the USDT and returns it to the flashloan lender and swaps the remaining 2.836 million USDT into WETH for profit. The attackers used the same method to launch an attack on the BSC chain and made $191,000 in profit.</p><p>The root cause of the attack was the contract exchange function is not protected from reentrancy...</p></blockquote><p>Peckshield <a href="https://twitter.com/peckshield/status/1621337925228306433">produced</a> the following diagram showing the basic attack steps:</p><p><figure><img alt="" src="https://raw.githubusercontent.com/RektHQ/Assets/main/images/2023/01/orion-code.png"/></figure></p><p><strong>Attacker address 1 (<a href="https://etherscan.io/address/0x3dabf5e36df28f6064a7c5638d0c4e01539e35f1">ETH</a>, <a href="https://bscscan.com/address/0x3dabf5e36df28f6064a7c5638d0c4e01539e35f1">BSC</a>): 0x3dabf5e36df28f6064a7c5638d0c4e01539e35f1</strong></p><p><strong>Attacker address 2 (<a href="https://etherscan.io/address/0x837962b686fd5a407fb4e5f92e8be86a230484bd">ETH</a>, <a href="https://bscscan.com/address/0x837962b686fd5a407fb4e5f92e8be86a230484bd">BSC</a>): 0x837962b686fd5a407fb4e5f92e8be86a230484bd</strong></p><p>Example tx (BSC): <a href="https://bscscan.com/tx/0xfb153c572e304093023b4f9694ef39135b6ed5b2515453173e81ec02df2e2104">0xfb153c57…</a></p><p>Example tx (ETH): <a href="https://etherscan.io/tx/0xa6f63fcb6bec8818864d96a5b1bb19e8bd85ee37b2cc916412e720988440b2aa">0xa6f63fcb…</a></p><p>Stolen funds have mostly been deposited to Tornado Cash, with approximately $1M of ETH remaining in the Ethereum address. The attacker’s account was funded from a Binance-labelled wallet, though the original source was <a href="https://twitter.com/pcaversaccio/status/1621202593274888196">allegedly another CEX</a>, SimpleSwap.</p><p><figure><img alt="" src="https://raw.githubusercontent.com/RektHQ/Assets/main/images/2021/03/rekt-linebreak.png"/></figure></p><p><strong>In his thread on the incident, Orion’s CEO Alexey Koloskov <a href="https://twitter.com/alexeykoloskov/status/1621269268959477763">stated</a> his confidence in his own team’s code:</strong></p><blockquote><p>We have reasons to believe that the issue was not a result of any shortcomings in our core protocol code, but rather might have been caused by a vulnerability in mixing third-party libraries in one of the smart contracts used by our experimental and private brokers.</p></blockquote><p>But when such large amounts of money are on the line, security must be considered at all levels of a project’s stack.</p><p>And it appears that this $3M loss has <a href="https://twitter.com/alexeykoloskov/status/1621269275020333056">motivated</a> Orion to take a more controlled approach:</p><blockquote><p>Moving forward, any and all contracts will be developed in-house to eliminate any potential vulnerabilities from third-party libraries. Our focus is to fortify the Orion Protocol and make sure it remains robust.</p></blockquote><p><em>Glad to hear Orion will be taking security more Sirius-ly.</em></p><p><figure><img alt="" src="https://raw.githubusercontent.com/RektHQ/Assets/main/images/2021/08/rekt-outline-conc.png"/></figure></p>