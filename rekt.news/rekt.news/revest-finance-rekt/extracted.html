<section class="post-content"><p><figure><img alt="" src="https://raw.githubusercontent.com/RektHQ/Assets/main/images/2022/03/revest-header.png"/></figure></p><p><strong>~$2M taken from Revest Finance.</strong></p><p>A financial NFT platform which “offers instant liquidity for locked assets”, fell victim to a reentrancy attack.</p><p>A fast reaction from the Revest team prevented them from losing more funds, however, they still take a place on <a href="https://rekt.news/leaderboard/">the leaderboard  (#67)</a>.</p><p><em>How did it happen?</em></p><p><figure><img alt="" src="https://raw.githubusercontent.com/RektHQ/Assets/main/images/2021/09/rekt-investigates-linebreak.png"/></figure></p><p><strong>The Revest team were informed of the <em>“exploit at 2:24 UTC from the BLOCKS DAO development team</em>”.</strong></p><p>In addition to <a href="https://twitter.com/BLOCKS_DAO/status/1507948104829579279">BLOCKS DAO</a>, substantial losses were also suffered by <a href="https://twitter.com/finance_eco/status/1508166280792186884">EcoFi</a> and <a href="https://twitter.com/rena_finance/status/1508033798021459970">RENA Finance.</a></p><p>By <a href="https://etherscan.io/tx/0x18fd1a2b17109c7f2bb7244d99bcfb71d131fd9d522fdc41b8a9fb3cdded9c98">halting transfers</a> of RVST tokens, the team thwarted the <a href="https://etherscan.io/tx/0x7bbc01ad66ba9b07fdc82afe4e0c99ffcf317680635d040427afed06b25c8c0f">attacker’s attempt</a> <em>(70 secs later)</em> to drain the RVST-ETH pool on Uniswap, avoiding a further $1.15M in losses.</p><p>The attacker’s dump of the stolen tokens had a large impact on the price of <a href="https://www.coingecko.com/en/coins/blocks">BLOCKS</a> (initially down &gt;95%, currently down ~80%) and <a href="https://www.coingecko.com/en/coins/ecofi">ECO</a> (down ~98%), however the <a href="https://www.coingecko.com/en/coins/rena-finance">RENA</a> tokens remain untouched in the <a href="https://etherscan.io/address/0xef967ece5322c0d7d26dab41778acb55ce5bd58b">attackers address.</a></p><p><em>Credit: <a href="https://twitter.com/BlockSecTeam/status/1508065573250678793">@BlockSecTeam</a></em></p><p><strong>The root-cause of the attack was due to a reentrancy vulnerability in the ERC1155 minting contract (<a href="https://etherscan.io/tx/0xe0b0c2672b760bef4e2851e91c69c8c0ad135c6987bbf1f43f5846d89e691428">example tx: RENA</a>)</strong></p><p>The function <em>mintAddressLock</em>, used to create new Smart Vaults, contains two critical parameters: <em>quantities</em> and <em>depositAmount</em>.</p><p>Revest Vault invokes the <em>mint</em> function of FNFTHandler, to mint <em>quantities</em> of ERC1155(s) with the next <em>fnftId</em> to the recipient(s) which can later be burned in order to claim the position’s proportion of locked tokens. <em>fnftId</em> increments by 1 each time the function is executed.</p><p>Extra funds can be deposited to the FNFT using the <em>depositAdditionalToFNFT</em> function, deposits must be in the same proportion as defined by <em>quantities</em>, specifically: <em>quantity==FNFTHandler.getSupply(fnftId)</em>.</p><p>If the above statement is not fulfilled, the user's share will be extracted from the position and transferred to a new FNFT with a balance defined by the existing position's <em>depositAmount</em> plus the newly deposited amount.</p><p>Given that the existing position’s <em>depositAmount</em> is used, but <em>fnftId</em> (informed via <em>fnftsCreated</em>) is not updated until the end of the minting routine, re-entrancy at this point allows for additional funds to be added to an existing position.</p><p><figure><img alt="" src="https://raw.githubusercontent.com/RektHQ/Assets/main/images/2022/03/revest-code.png"/></figure></p><p><strong>Step by Step:</strong></p><p><strong>1:</strong> Attacker uses the <em>mintAddressLock</em> function to open a new position with <em>fnftId=1027</em>, <em>depositAmount=0</em>, <em>quantities=[2]</em>, <em>asset=Rena</em>, and <em>recipients=[malicious contract]</em>.  Since the <em>depositAmount X quantities[0] = 0 X 2 = 0</em>, the attacker transfers zero Rena.</p><p><strong>2:</strong> Attacker uses the <em>mintAddressLock</em> function again to open a new position with <em>fnftId=1028</em>, <em>depositAmount=0</em>, <em>quantities=360,000</em>, <em>asset=Rena</em>, and <em>recipients=[malicious contract]</em>. Again, the attacker transfers zero Rena and receives <em>360,000</em> tokens (with <em>fnftId=1028</em>). Note that these 1028-tokens have no value now.</p><p><strong>3:</strong> At the end of Step 2, during the <em>mint</em> function of <em>FNFTHandler</em>, the attacker re-enters the <em>Revest</em> contract via the <em>onERC1155Received</em> interface. The <em>depositAdditionalToFNFT</em> function is used with <em>amount = 1e18</em>, <em>quantities=1</em>, <em>fnftId=1027</em>, which would normally open the <em>fnftId=1029</em> (new) position. However, due to the delay in updating <em>fnftId</em>, position 1028 is overwritten with the above data, ascribing value to the 1028 tokens owned by the attacker.</p><p><strong>4:</strong> The attacker uses the <em>withdrawFNFT</em> function to withdraw the <em>360,000 X 1e18</em> Rena tokens after having deposited only <em>1 quantity X 1e18</em> Rena tokens in Step 3.</p><p>Token losses (approx $2M total) according to the <a href="https://revestfinance.medium.com/revest-protocol-exploit-recovery-plan-b06ca33fbdf5">official post-mortem report</a>:</p><p>350k RENA <em>(~$125k, still in <a href="https://etherscan.io/address/0xef967ece5322c0d7d26dab41778acb55ce5bd58b">attacker’s address</a>)</em></p><p>715M BLOCKS <em>(~$1.7M)</em></p><p>7.7M ECO <em>(~$100k)</em></p><p><strong>Smaller amounts ($10-$12K) of <a href="https://etherscan.io/tx/0x2b73bc0af8eaaff12eda97105071ac093ea610c00fd2ee7d33c0020f617feeeb">ConstitutionDAO</a> and <a href="https://etherscan.io/tx/0x3b902013ea6e15587dd876d37182cfc09d208cac27fb33ddfa850e8eae4a8597">LUKSO</a> were also stolen.</strong></p><p>After swapping the majority of the stolen tokens for ETH, the attacker <a href="https://etherscan.io/address/0xef967ece5322c0d7d26dab41778acb55ce5bd58b">deposited the funds</a> into Tornado Cash.</p><p><figure><img alt="" src="https://raw.githubusercontent.com/RektHQ/Assets/main/images/2021/03/rekt-linebreak.png"/></figure></p><p><strong>A security breach is never a good look for a DeFi protocol, especially when its product is a secure locker to be trusted with other project’s tokens.</strong></p><p>“One audit is never enough” says Revest, as they found that the vulnerability was not picked up in the <a href="https://solidity.finance/audits/Revest/">project’s audit</a> (solidity.finance).</p><p>The team’s quick response and thorough post-mortem are promising signs, and although Revest have stated that “<em>we do not possess the funds needed for meaningful financial recompense</em>”, the postmortem report stresses the desire to make things right in the future.</p><p><em>At the moment, it’s not clear how that will happen.</em></p><p><figure><img alt="" src="https://raw.githubusercontent.com/RektHQ/Assets/main/images/2021/08/rekt-outline-conc.png"/></figure></p>