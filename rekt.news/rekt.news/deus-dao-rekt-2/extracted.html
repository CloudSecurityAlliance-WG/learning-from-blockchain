<section class="post-content"><p><figure><img alt="" src="https://raw.githubusercontent.com/RektHQ/Assets/main/images/2022/04/deus2-header.png"/></figure></p><p><strong>Deus DAO dealt double damage.</strong></p><p>On 15th March, the project’s users were liquidated for a total of $3M.</p><p>In an unfortunate sequel, the protocol has now lost a further $13.4M.</p><p>Deus DAO <a href="https://twitter.com/DeusDao/status/1519574219419496449">recognised</a> the exploit stating that:</p><blockquote><ol><li><p>User funds are safe. No users were liquidated</p></li><li><p>DEI lending has been temporarily halted</p></li><li><p>$DEI peg has been restored.</p></li></ol></blockquote><p>This attack used a similar technique to the first; oracle manipulation to inflate the value of DEI collateral, however this time the process was more complex.</p><p><strong>In <a href="https://rekt.news/deus-dao-rekt/">last month’s article</a> we asked:</strong></p><p><em>Why didn’t Deus DAO have a more robust system in place?</em></p><p>In Deus DAO’s <a href="https://lafayettetabor.medium.com/deus-post-mortem-3c65df12927f">official response</a>, Lafayette Tabor explained that the integration of Muon’s off-chain VWAP oracle was “<em>designed exactly to prevent this</em>”.</p><p>It was then <a href="https://discord.com/channels/746652484382228480/895295996672745502/954875912321642506">announced on Discord</a> on March 19th that “Muon oracles are ready and implemented”.</p><p><em>But it seems the new system wasn't enough to keep the protocol safe.</em></p><p>How did the attacker bypass the new oracle?</p><p><figure><img alt="" src="https://raw.githubusercontent.com/RektHQ/Assets/main/images/2021/09/rekt-investigates-linebreak.png"/></figure></p><p><strong>This exploit was <a href="https://twitter.com/lafachief/status/1519616442412449792">not as straightforward</a> as the last.</strong></p><p>The hacker needed to trick the off-chain (Muon) oracle as well as manipulate the on-chain price feed <em>(the same USDC/DEI pool as before)</em>.</p><p>The Muon oracle monitors transactions within the Solidly USDC/DEI pool to calculate a Volume Weighted Average Price (VWAP). Four minutes before the main attack transaction, a separate <a href="https://ftmscan.com/tx/0x8589e136e6ad927096d07baa16852d16f11456c0446efb8f1ecd467ce0d4cb10">transaction</a> was able to <a href="https://twitter.com/lafachief/status/1519624606180691968">“fake”</a> a swap of ~2M USDC to 100k DEI.</p><p>The funds necessary to finance this manipulation were <a href="https://etherscan.io/address/0x700a81265ea72f609eaf9d0f08356c94b1c5af52#internaltx">initially withdrawn</a> from Tornado Cash before being <a href="https://etherscan.io/tx/0x96a06ee8ffc205f33ec6a2645bf240d1b577cd8085e1504525c108997e833fb8">sent on</a> to the exploiter’s address, swapped for $2M USDC and then sent via Multichain to Fantom (example tx: <a href="https://etherscan.io/tx/0xf4b19a90df1eed9faf8672876996f56ed57fc3702d98d3efa2262a598b102428">send</a>, <a href="https://ftmscan.com/tx/0x80e70a4956216630aa0d9ec4edc1a1c3dd35cec898b6cfda05fda9435bd270f8">receive</a>).</p><p>In what Tabor claims to be a <a href="https://twitter.com/lafachief/status/1519645308061462528">“<em>a zero-day exploit on Solidly swaps</em>”</a>, a series of flash-swaps inside the same pool outputs a manipulated price, which is read by the Muon oracle.</p><p>He went on to explain via DM that:</p><blockquote><p>”we came to the conclusion it all is based on the fact the muon oracle implementation only used Solidly as a price source, they have been working on upgrading that already.</p><p>the swap used flashswap() that wasnt filtered out properly by muon leading to a short term VWAP price glitch…</p><p>…Main takeaway based on the whitehackers anlysis is to change muon vwap pricing to filter out obscure swaps and use multiple data sources."</p></blockquote><p>After having prepared the Muon oracle, at 02:40 UTC, the <a href="https://ftmscan.com/tx/0x39825ff84b44d9c9983b4cff464d4746d1ae5432977b9a65a92ab47edac9c9b5">main attack</a> targeted the USDC/DEI pool used by the lending contract as an on-chain oracle for DEI, using the same process as before.</p><p><em>Credit: <a href="https://twitter.com/peckshield/status/1519533378529562624">Peckshield</a></em></p><p><strong>1:</strong> Flashloan 143,200,000 USDC</p><p><strong>2:</strong> Swap 143,200,000 USDC to 9,547,716 DEI via sAMM-USDC/DEI_USDC_DEI (so DEI becomes extremely expensive)</p><p><strong>3:</strong> With 71,436 DEI as collateral, attacker borrows 17,246,885 DEI from DeiLenderSolidex due to the manipulated price in step 2</p><p><strong>4:</strong> Repay flashloan with ~$13M as hack profit</p><p><strong>While last month’s attack manipulated collateral price in order to liquidate borrowers, this time, the collateral was used to borrow funds directly from the protocol.</strong></p><p>The loot <em>(5446 ETH, including the funds used to finance the Muon manipulation)</em> was sent from the attacker’s address on <a href="https://ftmscan.com/address/0x701428525cbac59dae7af833f19d9c3aaa2a37cb">Fantom</a> to <a href="https://etherscan.io/address/0x701428525cbac59dae7af833f19d9c3aaa2a37cb">Ethereum</a> and then on to Tornado Cash.</p><p><strong>Muon oracle manipulation tx:</strong> <a href="https://ftmscan.com/tx/0x8589e136e6ad927096d07baa16852d16f11456c0446efb8f1ecd467ce0d4cb10">0x8589e1…</a></p><p><strong>Main flashloan attack tx:</strong> <a href="https://ftmscan.com/tx/0x39825ff84b44d9c9983b4cff464d4746d1ae5432977b9a65a92ab47edac9c9b5">0x39825f… </a></p><p><strong>Attacker’s address (FTM):</strong> <a href="https://ftmscan.com/address/0x701428525cbac59dae7af833f19d9c3aaa2a37cb">0x701428… </a></p><p><strong>Attacker’s address (ETH):</strong> <a href="https://etherscan.io/address/0x701428525cbac59dae7af833f19d9c3aaa2a37cb">0x701428…</a></p><p>Despite this being the second incident to affect the project in as many months, the price of <a href="https://www.coingecko.com/en/coins/deus-finance">DEUS</a> has returned close to pre-hack prices, after an initial ~20% drop. <a href="https://www.coingecko.com/en/coins/dei-token">DEI</a> has been trading under peg since the incident, but appears to be stabilising over time.</p><p><figure><img alt="" src="https://raw.githubusercontent.com/RektHQ/Assets/main/images/2021/03/rekt-linebreak.png"/></figure></p><p><strong>Given the oracle is a new product and the swap vulnerability is allegedly previously unknown, it's no surprise that the <a href="https://github.com/deusfinance/lending-audit/blob/main/Armor%20Labs%20Audit%20report/DEUS%20Lending_audit.pdf">Armors Labs’ audit</a> of Deus’ lending product did not pick up the issue.</strong></p><p>However, even if the claims of a novel vulnerability are accurate, Tabor’s admissions show that the Muon oracle wasn’t up to task - it shouldn’t have been using a single price source, and had inadequate filtering of “obscure swaps”.</p><p>Both of these factors will be addressed and, similarly to last time, the project will be <a href="https://twitter.com/lafachief/status/1519624610194599938">covering losses</a>, this time via veDEUS funds.</p><p>There are reliable, established and already battle-tested options to choose from.</p><p>While innovation is admirable, <a href="https://samczsun.com/so-you-want-to-use-a-price-oracle/">security standards</a> emerged from our <a href="https://rekt.news/on-flash-loans/">baptism of fire.</a></p><p><em>Let’s make sure to use them.</em></p><p><figure><img alt="" src="https://raw.githubusercontent.com/RektHQ/Assets/main/images/2021/08/rekt-outline-conc.png"/></figure></p>