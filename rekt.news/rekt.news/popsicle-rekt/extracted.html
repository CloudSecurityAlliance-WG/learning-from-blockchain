<section class="post-content"><p><figure><img alt="" src="https://raw.githubusercontent.com/RektHQ/Assets/main/images/2021/08/popsicle-header.png"/></figure>
<strong>Meltdown.</strong></p><p>~$20 million gone.</p><p>A complex hack of a <a href="https://twitter.com/Mudit__Gupta/status/1422797923037814786?s=20">simple bug</a> leaves <a href="https://twitter.com/PopsicleFinance/status/1422748604524019713?s=20">Popsicle Finance</a> in a sticky situation.</p><p><em>The <a href="https://twitter.com/WildCredit/status/1406939127229026304?s=20">RewardDistribution</a> bug has already been exploited in several other protocols.</em></p><p><strong>Auditors and Smart contract developers need to stay up to date. This code should not have made it to production.</strong></p><p><em>If only there was <a href="https://www.rekt.news/">somewhere</a> they could read about previous hacks and exploits...</em></p><p><figure><img alt="" src="https://raw.githubusercontent.com/RektHQ/Assets/main/images/2021/08/popsicle-investigates.png"/></figure></p><blockquote><p>Credit: <a href="https://twitter.com/peckshield/status/1422776188913819648?s=20">@Peckshield</a> &amp; <a href="https://twitter.com/Mudit__Gupta/status/1422797923037814786?s=20">@Mudit__Gupta</a></p></blockquote><p><strong>Attacker address:</strong> <a href="https://etherscan.io/address/0xf9e3d08196f76f5078882d98941b71c0884bea52">0xf9E3D08196F76f5078882d98941b71C0884BEa52</a></p><p><strong>Transaction Hash:</strong> <a href="https://etherscan.io/tx/0xcd7dae143a4c0223349c16237ce4cd7696b1638d116a72755231ede872ab70fc">0xcd7dae143…</a></p><p><figure><img alt="" src="https://raw.githubusercontent.com/RektHQ/Assets/main/images/2021/08/popsicle-peckshield.png"/></figure></p><blockquote><p>The “Sorbetto Fragola” contract automatically manages Liquidity on Uniswap V3. Fragola adjusts the position so it is always in the correct range.</p></blockquote><p><strong>The hack was due to the lack of proper fee accounting when LP tokens are transferred.</strong></p><p><em>Specifically, the attacker creates three contracts: A, B, and C and repeats in the sequences of:</em></p><p>A.deposit(),</p><p>A.transfer(B),</p><p>B.collectFees(),</p><p>B.transfer(C),</p><p>C.collectFees() for eight pools.</p><p><strong>Step 1:</strong> Flashloan 30M USDT, 13K WETH, 1.4KBTC, 30M USDC, 3M DAI and 200K UNI from Aave to attack eight PLP pools.</p><p><em>Below we take the USDT-WETH pool as an example.</em></p><p><strong>Step 2:</strong> Alice calls deposit() to add 30M USDT and 5.467K WETH liquidity into the USDT-WETH PLP pool and gets 10.51 PLP tokens.</p><p><strong>Step 3:</strong> A transfers the 10.52 PLP tokens to B</p><p><strong>Step 4:</strong> B calls the collectFees() function to get its tokenRewards updated.</p><p><strong>Step 5:</strong> B transfers the 10.52 PLP tokens to C</p><p><strong>Step 6:</strong> C calls the collectFees() function to get its tokenRewards updated.</p><p><strong>Step 7:</strong> C transfers the 10.52 PLP tokens back to A, so A will be able to remove the liquidity later on.</p><p><strong>Step 8:</strong> A calls withdraw() to remove the liquidity and gets back 30M USDT and 5.46 WETH.</p><p><strong>Step 9:</strong> B calls collectFees() to get 2.15M USDT and 392 WETH as rewards.</p><p><strong>Step 10:</strong> C calls collectFees() to get 2.15M USDT and 402 WETH as rewards.</p><p><strong>Step 11:</strong> The attacker repeats step 2 to 10 for several other PLP pools and repays the flashloan in step 1.</p><p><strong>A portion of the attack's profits (4,100 ETH, about $10M) is immediately deposited to Tornado Cash.</strong></p><p><em>At the time of writing, the remaining 2,560 WETH, 96 WBTC and 159,928 DAI are still in the attacker account:</em> <a href="https://etherscan.io/address/0xf9e3d08196f76f5078882d98941b71c0884bea52">0xf9E3D08196F76f5078882d98941b71C0884BEa52.</a></p><p><figure><img alt="" src="https://raw.githubusercontent.com/RektHQ/Assets/main/images/2021/08/popsicle-linebreak-logo.png"/></figure></p><p><strong>Everyone makes mistakes, but not many are responsible for $20M TVL…</strong></p><p>It’s strange that Peckshield decided to publish a post-mortem of code that they audited, instead of waiting and releasing it as an official release from the Popsicle account.</p><p><strong>Another client's funds lost, while Peckshield chase clout on Twitter.</strong></p><p>There is little excuse for the auditors for missing an already known bug.</p><p><em>They did write a nice post-mortem though, so at least Popsicle Finance got something for their money.</em></p><p><figure><img alt="" src="https://raw.githubusercontent.com/RektHQ/Assets/main/images/2021/08/rekt-outline-conc.png"/></figure></p>