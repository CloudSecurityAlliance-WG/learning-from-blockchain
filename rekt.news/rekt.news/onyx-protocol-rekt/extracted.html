<section class="post-content"><p><figure><img alt="" src="https://raw.githubusercontent.com/RektHQ/Assets/main/images/2023/01/onyx-header.png"/></figure></p><p><em>Another total fork-up.</em></p><p><strong><a href="https://twitter.com/OnyxProtocol">Onyx Protocol</a>, a Compound Finance fork, lost $2.1M on Tuesday to a high-profile, well-known vulnerability.</strong></p><p>The exact same attack vector has hit two other forks, <a href="https://rekt.news/hundred-rekt2/">Hundred Finance</a> and <a href="https://rekt.news/midas-rekt2/">Midas Capital</a> (<em>themselves both repeat <a href="https://rekt.news/leaderboard/">leaderboard</a> entrants</em>), already this year, tipping the total lost to this bug over the $10M mark.</p><p>Peckshield, as ever, <a href="https://twitter.com/peckshield/status/1719656987124965677">warned</a> Onyx to “<em>take a look</em>”. However, no official response came for almost three hours, when a team member <a href="https://twitter.com/al_onyxprotocol/status/1719698066020733063">acknowledged</a> the loss.</p><p>In the meanwhile, and while TG mods were <a href="https://t.me/OnyxOrg/52458">urging</a> users “<em>Please don’t fud</em>” the protocol was hit by a repeat <a href="https://etherscan.io/tx/0x27a3788d504af542681436bfdecf1823f7a8a691d04309ad33e6d3825e899746">attack</a>, though for substantially <a href="https://twitter.com/PeckShieldAlert/status/1719665280715231717">less profit</a> ($~62k).</p><p>Many protocols have fallen victim to repeated exploits of identical vulnerabilities over the course of the year, with read-only reentrancy also claiming multiple victims including <a href="https://rekt.news/conic-finance-rekt/">Conic</a>, <a href="https://rekt.news/sturdy-rekt/">Sturdy</a>, <a href="https://rekt.news/eralend-rekt/">EraLend</a> and <a href="https://rekt.news/midas-capital-rekt/">Midas</a>.</p><p><em>Are the devs paying attention?</em></p><p><figure><img alt="" src="https://raw.githubusercontent.com/RektHQ/Assets/main/images/2021/09/rekt-investigates-linebreak.png"/></figure></p><p>Credit: <em><a href="https://twitter.com/peckshield/status/1719664641109037551">Peckshield</a>, <a href="https://twitter.com/Phalcon_xyz/status/1719697319824851051">BlockSec</a></em></p><p><strong>The exploit was made possible due to a <a href="https://www.comp.xyz/t/hundred-finance-exploit-and-compound-v2/4266">known vulnerability</a> of Compound v2 code. Under certain conditions, a rounding error allows an attacker to manipulate empty markets in order to drain liquidity from across the protocol.</strong></p><p>In Onyx’ case, governance had recently voted through <a href="https://onyx.org/governance/proposal/22">Proposal 22</a> to add a lending market for memecoin PEPE to the protocol.</p><p>The ‘empty market attack’ involves taking a flash loan which is swapped, in this case, for PEPE. Then, by minting a small number of shares (oPEPE) and donating a large amount of PEPE to the pool, vastly inflating the price of oPEPE for use as collateral on Onyx.</p><p>Other assets can then be borrowed against the overvalued oPEPE, draining the protocol’s liquidity. The rounding error is then exploited to withdraw the donated funds, and the flash loan is repaid.</p><p><figure><img alt="" src="https://raw.githubusercontent.com/RektHQ/Assets/main/images/2023/01/onyx-code.png"/></figure></p><p>Exploiter address: <strong><a href="https://etherscan.io/address/0x085bdff2c522e8637d4154039db8746bb8642bff">0x085bdff2c522e8637d4154039db8746bb8642bff</a></strong></p><p>Attack tx: <a href="https://etherscan.io/tx/0xf7c21600452939a81b599017ee24ee0dfd92aaaccd0a55d02819a7658a6ef635">0xf7c21600…</a></p><p>Repeat exploiter address: <a href="https://etherscan.io/address/0x5083956303a145f70ba9f3d80c5e6cb5ac842706">0x5083956303a145f70ba9f3d80c5e6cb5ac842706</a></p><p>Repeat-attack tx: <a href="https://etherscan.io/tx/0x27a3788d504af542681436bfdecf1823f7a8a691d04309ad33e6d3825e899746">0x27a3788d…</a></p><p><strong>The 1164 ETH ($2.1M) of profits were sent on to an <a href="https://etherscan.io/address/0x4c9c8661243e9e9a15a35b8873317eb881330c98">intermediary address</a> before 1140 ETH were <a href="https://etherscan.io/advanced-filter?fadd=0x4c9c8661243e9e9a15a35b8873317eb881330c98&amp;tadd=0xd90e2f925DA726b50C4Ed8D0Fb90Ad053324F31b&amp;txntype=0&amp;qt=1">deposited</a> into Tornado Cash.</strong></p><p><em>The <a href="https://t.me/investigations/68">remaining 24 ETH</a> were sent to on-chain panhandlers, prompting a follow-up stream of <a href="https://etherscan.io/idm?addresses=0x4c9c8661243e9e9a15a35b8873317eb881330c98">input data messages</a> to the hacker’s address, begging for further scraps.</em></p><p><figure><img alt="" src="https://raw.githubusercontent.com/RektHQ/Assets/main/images/2021/03/rekt-linebreak.png"/></figure></p><p>Onyx Protocol was <a href="https://skynet.certik.com/projects/onyx-protocol">audited by Certik</a>, however the viability of this vulnerability is ultimately determined by the conditions within the individual market, rather than the codebase in itself.</p><p><strong>Empty markets in Comp v2 code are a known issue; the launch of new markets should be treated especially carefully by project teams.</strong></p><p>The <a href="https://www.comp.xyz/t/hundred-finance-exploit-and-compound-v2/4266">discussion</a> following the (second) Hundred Finance hack references Hexagate’s <a href="https://twitter.com/hexagate_/status/1650177766187323394">recommendations</a> for launching potentially vulnerable markets (“<em>markets with low total supply and a non-zero collateral factor (CF)</em>”):</p><blockquote><p>we recommend any Compound V2 fork, when launching new markets to mint some cTokens and burn them to make sure the total supply never goes to zero. When the total supply goes to zero, the protocol becomes vulnerable and this strategy mitigates this situation.</p><p>That means that when listing a new collateral token, first set its collateral factor to zero, set in the Comptroller, mint some cTokens, burn them and then change the collateral factor to the desired factor.</p></blockquote><p><em>Compound itself has many eyes scouring all governance proposals, though the <a href="https://rekt.news/overcompensated/">occasional blunder</a> does <a href="https://rekt.news/compound-rekt/">seem to</a> slip <a href="https://rekt.news/compound-errors/">through</a>…</em></p><p>But with just 11 wallets voting on Proposal 22 (<em>and over 97% of votes coming from a single address</em>), perhaps Onyx doesn’t have the same level of community vigilance over its lending markets.</p><p><strong>For teams working with forks, devs must be sure to stay on top of the security landscape, to avoid getting rekt by replicated vulnerabilities.</strong></p><p><em>Blackhats are certainly keeping up-to-date.</em></p><p><strong>Onyx’ proposed <a href="https://community.onyx.org/t/the-onyxprotocol-experienced-an-exploit/1125/5">compensation plan</a> intends to refund victims by selling native tokens from the treasury, while DAO contributors' salaries will be paused until further notice.</strong></p><p>While superficially sounding like a fair and selfless way to make users whole, the plan has the potential to trigger a death sprial on XCN, whilst the team’s incentives grow increasingly misaligned…</p><p><em>What could go wrong?</em>
<figure><img alt="" src="https://raw.githubusercontent.com/RektHQ/Assets/main/images/2021/08/rekt-outline-conc.png"/></figure></p>