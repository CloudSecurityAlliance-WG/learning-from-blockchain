<section class="post-content"><p><figure><img alt="" src="https://raw.githubusercontent.com/RektHQ/Assets/main/images/2022/03/agavehundred-header.png"/></figure></p><p><strong>Two forks met the same fate.</strong></p><p><a href="https://twitter.com/Agave_lending/status/1503725275917565954?s=20&amp;t=Ljd0MHhMQUZqPX-v8Qw_fg">Agave DAO</a>, <em>(an Aave fork)</em>, and <a href="https://twitter.com/HundredFinance/status/1503754916300476420?s=20&amp;t=5rAiSnRTdUV1eTN50HwBiA">Hundred Finance</a>, <em>(a Compound fork)</em>, both fell victim to the same reentrancy attack.</p><p>2116 ETH ($5.5M) was lost from Agave, and 2363 ETH ($6.2M) from Hundred Finance, giving a total of $11.7M stolen by the anonymous attacker.</p><p>This is the first attack we’ve seen on the Gnosis (xDai) chain, and the first time we’ve seen two protocols be directly targeted like this.</p><p><strong>However, considering the structure of DeFi today, the double damage is not surprising.</strong></p><p>Forks upon forks create a house of cards. If the code is copied and pasted, vulnerabilities can open up where they're least expected.</p><p><em>When one fork falls, all others have to check their foundations.</em></p><p><figure><img alt="" src="https://raw.githubusercontent.com/RektHQ/Assets/main/images/2021/09/rekt-investigates-linebreak.png"/></figure></p><p><em>Credit: <a href="https://twitter.com/danielvf/status/1503756428212936710">Daniel Von Fange</a> and <a href="https://twitter.com/mudit__gupta/status/1503783633877827586">Mudit Gupta</a></em></p><p><strong>The attacks were made possible due to the design of the xDAI token which contains the function <em>callAfterTransfer()</em> creating a reentrancy vulnerability.</strong></p><p>Using flash loans as initial collateral, the attacker(s) nested additional borrow functions inside one another, increasing the amount borrowed before the protocol could update the debt balance. Repeating this process led to borrowing assets worth far more than the collateral supplied.</p><p>The attack vector is the same as in the $18.8M case of <a href="https://rekt.news/cream-rekt/">CREAM Finance</a> last August.</p><p><strong>Agave DAO</strong></p><p><a href="https://dashboard.tenderly.co/tx/xdai/0xa262141abcf7c127b88b4042aee8bf601f4f3372c9471dbd75cb54e76524f18e">Exploit tx (March-15-2022 11:25:40 AM +1 UTC)</a></p><p>The stolen funds were then sent to the attacker’s <a href="https://etherscan.io/address/0x0a16a85be44627c10cee75db06b169c7bc76de2c">ETH address</a> and after a few hours 2116 ETH ($5.5M) were sent to Tornado Cash.</p><p><strong>Hundred Finance</strong></p><p><a href="https://dashboard.tenderly.co/tx/xdai/0x534b84f657883ddc1b66a314e8b392feb35024afdec61dfe8e7c510cfac1a098">Exploit tx (March-15-2022 11:28:40 AM +1 UTC)</a></p><p>The stolen funds were then sent to the attacker’s <a href="https://etherscan.io/address/0xd041ad9aae5cf96b21c3ffcb303a0cb80779e358">ETH address</a> and after a few hours 2363 ETH ($6.2M) were sent to Tornado Cash.</p><p><em>While the price of <a href="https://www.coingecko.com/en/coins/hundred-finance">HND</a> hasn’t suffered too badly from the news, <a href="https://www.coingecko.com/en/coins/agave-token">AGVE</a> plunged &gt;20%.</em></p><p><figure><img alt="" src="https://raw.githubusercontent.com/RektHQ/Assets/main/images/2021/03/rekt-linebreak.png"/></figure></p><p><strong>Forking strong code is not enough to ensure security after changes are made. The idiosyncrasies of each new environment bring new threats.</strong></p><p>In this case, the Gnosis (xDai) design revealed hidden dangers not considered when porting the protocols from Ethereum.</p><p>Though both projects are forks from foundational DeFi protocols (Aave and Compound), the original projects have strict vetting in place to avoid allowing tokens with reentrancy vulnerabilities to be used as collateral. Additionally, as Mudit Gupta pointed out, following a <a href="https://twitter.com/Mudit__Gupta/status/1503783638961299459">“checks-effects-interactions pattern”</a> is another way to mitigate such attacks from taking place.</p><p><em>Another entry on our <a href="https://rekt.news/leaderboard/">leaderboard (#35)</a>, and another lesson learned the hard way.</em></p><p><figure><img alt="" src="https://raw.githubusercontent.com/RektHQ/Assets/main/images/2021/08/rekt-outline-conc.png"/></figure></p>