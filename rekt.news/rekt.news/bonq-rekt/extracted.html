<section class="post-content"><p><figure><img alt="" src="https://raw.githubusercontent.com/RektHQ/Assets/main/images/2023/01/bonq-header.png"/></figure></p><p><strong><a href="https://bonqdao.com/">BonqDAO</a> got bonked for $120M.</strong></p><p><em>But the anonymous attacker got away with less than $2M.</em></p><p>The Polygon-based lending and stablecoin protocol was hit by a two-stage attack on Wednesday in another example oracle manipulation.</p><p>The alarm was raised on Twitter by <a href="https://twitter.com/spreekaway/status/1620864016741732353">@spreekaway</a>, who live-tweeted the dumping of stolen funds. The affected protocols, <a href="https://twitter.com/BonqDAO/status/1620908233761378304">BonqDAO</a> and <a href="https://twitter.com/allianceblock/status/1620887759656460289">AllianceBlock</a> (whose ALBT token was used in the exploit), both confirmed the hack in the following hours.</p><p>Despite all the action being visible on-chain, BonqDAO telegram admins attempted to <a href="https://twitter.com/spreekaway/status/1620874236368924673">downplay</a> the incident whilst the team presumably worked out what had happened.</p><blockquote><p>FUD and spam will not be tolerated</p></blockquote><p><em>rekt.news reckons: “using instant price feeds for collateral valuation will not be tolerated.”</em></p><p><figure><img alt="" src="https://raw.githubusercontent.com/RektHQ/Assets/main/images/2021/09/rekt-investigates-linebreak.png"/></figure></p><p>Credit: <em><a href="https://twitter.com/peckshield/status/1620917292514299904">Peckshield</a>, <a href="https://twitter.com/BeosinAlert/status/1621095640486006787">Beosin</a></em></p><p><strong>Attacker’s address:</strong> <a href="https://polygonscan.com/address/0xcacf2d28b2a5309e099f0c6e8c60ec3ddf656642">0xcacf2d28b2a5309e099f0c6e8c60ec3ddf656642</a></p><p><strong>Example attack tx:</strong> <a href="https://polygonscan.com/tx/0x31957ecc43774d19f54d9968e95c69c882468b46860f921668f2c55fadd51b19">0x31957ecc…</a></p><p><strong>Attacked smart contract:</strong> <a href="https://polygonscan.com/address/0x8f55d884cad66b79e1a131f6bcb0e66f4fd84d5b">0x8f55d884cad66b79e1a131f6bcb0e66f4fd84d5b</a></p><p>Samczsun <a href="https://twitter.com/samczsun/status/1620918455468982272">summarised</a> the attack as follows:</p><blockquote><p>the attacker said "btw 1 ALBT = 5 billion MATIC now" and Bonq said "ok"</p></blockquote><p>The hacker was able to manually update the <a href="https://twitter.com/WeAreTellor">Tellor</a> price feed of (wrapped) WALBT collateral by staking 10 TRB tokens (worth just ~$175).</p><p><strong>The attacker then used the submitValue function to report WALBT price to the oracle and, because BonqDAO uses the instant value, the attaker was able to borrow against their inflated collateral within the same tx.</strong></p><p><figure><img alt="" src="https://raw.githubusercontent.com/RektHQ/Assets/main/images/2023/01/bonq-code1.png"/></figure></p><p>Firstly, the ALBT price was raised, allowing the attacker to mint 100M BEUR, Bonq’s Euro-pegged stablecoin against 0.1 WALBT collateral.</p><p>Then, in a subsequent transaction, the WALBT price was reset to extremely low, allowing the attacker to liquidate user’s WALBT collateral, and netting approximately 113M WALBT.</p><p><figure><img alt="" src="https://raw.githubusercontent.com/RektHQ/Assets/main/images/2023/01/bonq-code2.png"/></figure></p><p><figure><img alt="" src="https://raw.githubusercontent.com/RektHQ/Assets/main/images/2023/01/bonq-code3.png"/></figure></p><p><strong>Beosin <a href="https://twitter.com/BeosinAlert/status/1621095640486006787">provided</a> a step-by-step:</strong></p><blockquote><p>The attacker calls the depositStake function of the TellorFlex contract, depositing 10 $TRB. Why 10 TRBs? We can see that the takeAmount is exactly 10*10^18</p><p>Next, the hacker calls the submitValue function to submit a request to change the $WALBT price. The function determines if the caller's stake amount has reached the pre-set takeAmount, which is why the attacker needs to first stake 10 TRB tokens (10^18 is decimal point).</p><p>This function will record the price submitted by the caller, in this case 50000000000000000000000000000000.</p><p>After the price is set, the hacker calls the createTrove function of the Bonq contract to create the trove(0x4248FD) contract, which is a contract of data recording, borrowing and liquidating. Next, the attacker stakes 0.1 $WALBT to the contract to perform a borrowing operation.</p><p>Normally, the borrowing amount should be &lt; 0.1 WALBT to ensure collateral rate in a safe range. But in this contract, the calculation of the collateral value is via TellorFlex contract. The attacker has already raised $WALBT price, thus being able to borrow 100M $BEUR.</p><p>The hacker sets $WALBT to a low price in 2nd TX. When the $WALBT price is extremely low, the stake rate of WALBTs staked by other users will be at liquidation, enabling hacker to liquidate $WALBT staked by other users at low cost, eventually obtaining ~114M WALBT.</p></blockquote><p>—</p><p><strong>Losses have been widely reported to be up to $120M, using the tokens’ prices at the time of the hack. But low liquidity meant the attacker has only managed to swap the loot to around $1.7M worth of ETH and DAI, so far.</strong></p><p><em>Nevertheless, the damage to BonqDAO was brutal, with <a href="https://defillama.com/protocol/bonqdao">TVL drained</a> from ~$13M yesterday to just over $100k at the time of writing.</em></p><p>Stolen BEUR was dumped on Polygon for just over $500K. Funds were then sent to the attacker’s <a href="https://etherscan.io/address/0xcacf2d28b2a5309e099f0c6e8c60ec3ddf656642">Ethereum address</a>, where the ALBT was repeatedly dumped for ETH. The attacker’s ETH address currently holds 711 ETH (~$1.2M) and 535k DAI, as well as 89M ALBT (supposedly worth ~$3M, if the attacker can find somewhere to sell it…).</p><p>BlockSec provided a detailed flowchart of funds, which can be <a href="https://twitter.com/MetaSleuth/status/1621006016065474560">found here</a>. The attacker’s ETH address was <a href="https://etherscan.io/tx/0xdf4f769c9acbf4fc1c8418a31cc68ff86a3ff296f330d4c0b89b327a2c199b06">funded</a> via Tornado Cash shortly before the attack, and the stolen funds have since been deposited back into the mixer.</p><p><figure><img alt="" src="https://raw.githubusercontent.com/RektHQ/Assets/main/images/2021/03/rekt-linebreak.png"/></figure></p><p>Omniscia’s <a href="https://omniscia.io/reports/bonq-borrowing-protocol/">audit</a> of BonqDAO raised concerns over “<em>multiple vulnerabilities as well as core design flaws</em>”.</p><p>According to Omniscia's <a href="https://medium.com/@omniscia.io/bonq-protocol-incident-post-mortem-4fd79fe5c932">post-mortem</a>, BonqDAO decided to:</p><blockquote><p>not move forward with the implementations audited at the time, opting to integrate Chainlink oracles in the future.</p><p>The Bonq Protocol has introduced numerous updates since the time the audit was finalized, including all contracts involved in the vulnerability (ConvertedPriceFeed, ChainlinkPriceFeed, and TellorPriceFeed). <strong>These contracts were never in scope of any audit conducted by the Omniscia team and thus are considered to be unaudited code.</strong></p></blockquote><p><strong>While it may have been BonqDAO had the vulnerability, AllianceBlock has suffered significant collateral damage from this incident.</strong></p><p>The sell-off of Bonq users' liquidated <a href="https://www.coingecko.com/en/coins/allianceblock">ALBT</a> caused its price to dump up to ~75% following the attack. AllianceBlock have stated they will <a href="https://twitter.com/allianceblock/status/1620887765058727936">reissue</a> the token and airdrop to users based on a Snapshot from before the hack.</p><p>Bonq’s Euro stablecoin, <a href="https://www.coingecko.com/en/coins/bonq-euro">BEUR</a>, has dropped to approximately 25% below its peg and the price of the DAO’s token, <a href="https://www.coingecko.com/en/coins/bonq">BNQ</a>, has also taken a hit of over 30%.</p><p><em>AllianceBlock may not be at fault for the vulnerability, but perhaps they need to work on their due diligence.</em></p><p>It may not be the most exciting part of DeFi, but it’s surely amongst the most important.</p><p>If AllianceBlock wants to achieve their aims of “<em>seamlessly bring[ing] DeFi and TradFi together</em>”, maybe they should take a more TradFi approach to due diligence.</p><p><em>But it looks like it may already be too late for Bonq.</em></p><p><figure><img alt="" src="https://raw.githubusercontent.com/RektHQ/Assets/main/images/2021/08/rekt-outline-conc.png"/></figure></p>