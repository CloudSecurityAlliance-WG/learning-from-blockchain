<section class="post-content"><p><figure><img alt="" src="https://raw.githubusercontent.com/RektHQ/Assets/main/images/2023/01/levana-header.png"/></figure></p><p><em>Gradually, then all at once.</em></p><p><strong>Perps platform Levana Protocol lost over $1.1M, or approximately 10% of the protocol‚Äôs liquidity, to an oracle manipulation attack lasting almost two weeks.</strong></p><p><em>The slow burn went unnoticed until network congestion fanned the flames.</em></p><p>A <a href="https://twitter.com/Levana_protocol/status/1740071199483543819">disclosure</a> published on Wednesday explained how the majority of the losses were realised when elevated gas costs on the Osmosis network suddenly made the exploit more profitable.</p><p><strong>The sharp increase in losses alerted the team, who responded by pausing the protocol.</strong></p><blockquote><p>The exploit started 14 days ago. Over a period of 12 days the attacker succeeded in draining approximately 4% of Levana's LPs.</p><p>The change in PnL was initially attributed to organic trader profits and lack of effective cash and carry on Levana's smaller markets.</p><p>Yesterday the attack increased significantly during Osmosis congestion, draining an additional ~5% from the pools until the protocol was closed from new positions being opened.</p></blockquote><p><strong>But if it hadn‚Äôt been for the increased network traffic‚Ä¶</strong></p><p><em>Would they have even noticed?</em></p><p><figure><img alt="" src="https://raw.githubusercontent.com/RektHQ/Assets/main/images/2021/09/rekt-investigates-linebreak.png"/></figure></p><p>Credit: <em><a href="https://blog.levana.finance/levana-exploit-postmortem-df89a72cc92b">Levana</a>, <a href="https://twitter.com/l_woetzel/status/1740086038624616525">Carter L. Woetzel</a></em></p><p>According to Levana‚Äôs <a href="https://blog.levana.finance/levana-exploit-postmortem-df89a72cc92b">post-mortem</a>, the attack began on December 13th, before ramping up significantly on December 26th.</p><p><strong>The exploit took advantage of temporary price discrepancies (delta) between oracle updates to place winning trades in ‚Äú<em>volatile markets with high leverage</em>‚Äù.</strong></p><p><em>Although the attack vector is fairly simple, context is key.</em></p><p>Oracle updates are pushed during regular user trades, as well as from Levana‚Äôs off-chain update bot, or every 90 seconds. But by timing attacks just right, and ensuring other transactions couldn‚Äôt get through, there was a window of opportunity every once in a while‚Ä¶</p><p>During the first stage, profits were minimal, as the exploit relied on a combination of conditions:</p><blockquote><p>You would have to find, or artificially create, a period where two events coincide: the large price delta in &lt;90 seconds, plus no other interrupting trading or bot activity</p></blockquote><p>The second, more profitable stage took advantage of a period of congestion on Osmosis; it remains unclear whether this congestion was organic or engineered for the purposes of the attack.</p><p>Whatever the cause, it allowed for more cases in which the exploiter was free to make their loaded bets as regular user txs couldn‚Äôt get through. The report <a href="https://blog.levana.finance/levana-exploit-postmortem-df89a72cc92b">explains</a>:</p><blockquote><p>A bug in the Osmosis fee market code meant that during times of congestion, the provided gas price was generally insufficient for making trades or performing ongoing bot maintenance activities.</p></blockquote><p><strong>To top it off, the project was subject to an ongoing DDoS attack over the majority of the exploit period, hampering their ability to respond.</strong></p><p>The markets affected and their losses (totaling $1.146M) are as follows:</p><p>stATOM_USD: $241k</p><p>ATOM_USD: $229k</p><p>BTC_USD: $190k</p><p>ETH_USD: $128k</p><p>TIA_USD: $108k</p><p>*_USDC: $168k + $82k</p><p><strong>The following step-by-step, provided by <a href="https://twitter.com/l_woetzel/status/1740086038624616525">Carter L. Woetzel</a>, shows the many factors at play.</strong></p><blockquote><p>1 Spam txs such that no oracle update txs can get through (from either users or Levana infra)</p><p>2 DDoS backend infra tied to regularly scheduled oracle update txs</p><p>3 Have an intelligent system tracking the deltaüî∫between the stale data and the actual market pricing that is ready to get pushed</p><p>4 Use a multiexecute tx to go long or short + update the stale data to market pricing - guaranteeing profit for the attacker as they know exactly what the stale price of the oracle is about to get updated to within their multiexecute tx while also comboing it with a long or short guaranteed to be directionally correct.</p><p>5 Because the attacker was the source of congestion, they knew precisely where to submit txs such that they would get accepted by the nodes</p></blockquote><p><figure><img alt="" src="https://raw.githubusercontent.com/RektHQ/Assets/main/images/2021/03/rekt-linebreak.png"/></figure></p><p>Levana had been <a href="https://docs.levana.finance/audits">audited</a> by both <a href="https://static.levana.finance/audit-reports/levana-perps-fyeo-v1.1.pdf">FYEO</a> and <a href="https://static.levana.finance/audit-reports/levana-perps-peckshield-v1.0.pdf">Peckshield</a> earlier in the year. However, bugs which rely on external factors such as network congestion don't look to have been within scope.</p><p>The project plans to make users whole via fees and an upcoming airdrop of <a href="https://www.coingecko.com/en/coins/levana">LVN</a> tokens, and is incorporating a transaction queuing system which will require a fresh oracle price to open positions.</p><p><strong>Even in the autonomous and disembodied world of DeFi, protocols do not exist in a vacuum.</strong></p><p>Fundamental considerations such as dependencies on external oracles and the reliance on an underlying network‚Äôs fee system must be constantly studied and meticulously tweaked to ensure a stable running product.</p><p><em>And with inscriptions fever spreading across all chains lately, any protocol could find themselves suddenly clogged up.</em></p><p>Crafty attackers may attempt to identify similar opportunities, waiting for congestion to hit a critical threshold, and ready to strike on multiple fronts.</p><p><strong>But considering the complexity of this hack, which took advantage of network-level pressures, protocol logic <em>and</em> off-chain systems, all combined with a distracting DDoS attack‚Ä¶</strong></p><p>Did Levana simply get unlucky?</p><p><em>Or are we seeing the emergence of even more nuanced and time sensitive attacks?</em></p><p><figure><img alt="" src="https://raw.githubusercontent.com/RektHQ/Assets/main/images/2021/08/rekt-outline-conc.png"/></figure></p>