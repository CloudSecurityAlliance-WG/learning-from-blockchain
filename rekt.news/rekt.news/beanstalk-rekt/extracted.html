<section class="post-content"><p><figure><img alt="" src="https://raw.githubusercontent.com/RektHQ/Assets/main/images/2022/04/bean-header.png"/></figure></p><p><strong>$181 million jacked from Beanstalk, but the attacker only kept $76M.</strong></p><p><a href="https://rekt.news/">rekt.news</a> records the damage, not the profit, so this one takes #5 on <a href="https://rekt.news/leaderboard/">the leaderboard.</a></p><p><strong>A malicious governance proposal was pushed through by a flash loan, and the attacker then voted to transfer all the assets to themself.</strong></p><p>Another ~24800 ETH into Tornado Cash, and 250K of stolen money into the Ukraine War Fund.</p><p><em>How much longer can this crimewave last?</em></p><p><figure><img alt="" src="https://raw.githubusercontent.com/RektHQ/Assets/main/images/2021/09/rekt-investigates-linebreak.png"/></figure></p><p><em>Credit: <a href="https://twitter.com/FrankResearcher/status/1515693895887294466">Igor Igamberdiev</a>, <a href="https://twitter.com/peckshield/status/1515692144190648322?s=20&amp;t=3UTlCZ7ksEn7DFljKsaNFg">Peckshield</a>, <a href="https://twitter.com/kelvinfichter/status/1515735717305008138">Kelvin Fichter</a></em></p><p><strong>This was a governance attack made possible through the use of flash loans combined with the absence of a delay on proposal execution.</strong></p><p>The attacker temporarily acquired sufficient voting power to immediately execute a malicious emergency governance proposal, draining the protocol.</p><p>Though the attack was instant, some <a href="https://twitter.com/kelvinfichter/status/1515735717305008138">preparation was needed:</a></p><blockquote><p><em>â€¦there's a ~1 day delay for <em>all</em> governance actions in the $BEAN contract. The attacker actually set this whole thing up yesterday when it made two governance proposals.</em></p><p><em>The first proposal (proposal #18) steals all the money in the contract. The next proposal (proposal #19) sends $250k worth of $BEAN to the Ukraine donation address. This Ukraine proposal is <em>named</em> Bip18 (instead of Bip19)...</em></p></blockquote><p><strong>Once the delay had passed, the attack could be <a href="https://twitter.com/FrankResearcher/status/1515693895887294466">executed:</a></strong></p><blockquote><p>The exploiter was funded from the Synapse Protocol bridge [though initially from Tornado].</p><p>They used a flash loan to get:</p><p>350M DAI, 500M USDC, and 150M USDT from Aave;</p><p>32M BEAN from Uniswap v2;</p><p>11.6M LUSD from SushiSwap.</p><p>These tokens were used to add liquidity to Curve pools with BEAN for the governance voting.</p><p>Further, they deployed and voted for a fake BIP-18 that moved all funds from the protocol contract to the exploiter.</p><p>The next step was removing liquidity, repaying flash loans, and converting all received funds into 24.8k WETH ($76M), which went to Tornado Cash.</p></blockquote><p><strong>Hacker:</strong> <a href="https://etherscan.io/address/0x1c5dcdd006ea78a7e4783f9e6021c32935a10fb4">0x1c5dcdd006ea78a7e4783f9e6021c32935a10fb4</a></p><p><strong>Hacker Contract:</strong> <a href="https://etherscan.io/address/0x79224bc0bf70ec34f0ef56ed8251619499a59def">0x79224bc0bf70ec34f0ef56ed8251619499a59def</a></p><p><strong>BIP18:</strong> <a href="https://etherscan.io/address/0xe5ecf73603d98a0128f05ed30506ac7a663dbb69">0xe5ecf73603d98a0128f05ed30506ac7a663dbb69</a></p><p><strong>Propose BIP18 tx:</strong> <a href="https://etherscan.io/tx/0x68cdec0ac76454c3b0f7af0b8a3895db00adf6daaf3b50a99716858c4fa54c6f">0x68cdec0ac76454c3b0f7af0b8a3895db00adf6daaf3b50a99716858c4fa54c6f</a></p><p><strong>Peckshield provided a <a href="https://twitter.com/peckshield/status/1515692144190648322">Step by Step</a></strong></p><p>Hacker proposes a malicious proposal BIP with <a href="https://etherscan.io/address/0xe5ecf73603d98a0128f05ed30506ac7a663dbb69">initAddress</a></p><p>Launch the hack tx: <a href="https://etherscan.io/tx/0xcd314668aaa9bbfebaf1a0bd2b6553d01dd58899c508d4729fa7311dc5d33ad7">0xcd314668aaa9bbfebaf1a0bd2b6553d01dd58899c508d4729fa7311dc5d33ad7</a></p><ol><li><p>Flashloan 350,000,000 DAI, 500,000,000 USDC, 150,000,000 USDC, 32, 425,202 BEAN, and 11,643,065 LUSD</p></li><li><p>Vyper_contract_bebc.add_liquidity 350,000,000 DAI, 500,000,000 USDC, 150,000,000 USDT to get 979,691,328 3Crv</p></li><li><p>LUSD3CRV-f.exchange to convert 15,000,000 3Crv to 15, 251,318 LUSD</p></li><li><p>BEAN3CRV-f.add_liquidity to convert 964,691,328 3Crv to 795,425,740 BEAN3CRV-f</p></li><li><p>BEANLUSD-f.add_liquidity to convert 32,100,950 BEAN and 26,894,383 LUSD and get 58,924,887 BEANLUSD-f</p></li><li><p>Deposit 795,425,740 BEAN3CRV-f and 58,924,887 BEANLUSD-f into Diamond</p></li><li><p>Diamond.vote (bip=18)</p></li><li><p>Diamond. emergencyCommit(bip=18) and hacker proposed _init contract is executed to get 36,084,584 BEAN and 0.54 UNI-V2_WETH_BEAN, 874,663,982 BEAN3CRV-f, 60,562,844 BEANLUSD-f to hacker contract</p></li><li><p>BEAN3CRV-f.remove_liquidity_one_coin 874,663,982 BEAN3CRV-f to get 1,007,734,729 3Crv</p></li><li><p>BEANLUSD-f.remove_liquidity_one_coin 60,562,844 BEANLUSD-f to get 28,149,504 LUSD</p></li><li><p>Flashloan back LUSD 11,795,706 and BEAN 32,197,543</p></li><li><p>LUSD3CRV-f.exchange to swap 16,471,404 LUSD to 16,184,690 3Crv</p></li><li><p>Burn 16,184,690 3Cry to get 522,487,380 USDC, 365,758,059 DAI, and 156,732,232 USDT</p></li><li><p>Flashloan back 150,135,000 USDT, 500,450,000 USDC, 350,315,000 DAI</p></li><li><p>Burn UNI-V2_WETH_BEAN 0.54 to get 10,883 WETH and 32,511,085 BEAN</p></li><li><p>Donate 250,000 USDC to Ukraine Crypto Donation</p></li><li><p>swap 15,443,059 DAI to 15,441,256 USDC</p></li><li><p>swap 37, 228,637 USDC to 11,822 WETH</p></li><li><p>Swap 6,597,232 USDT to 2,124 WETH</p></li><li><p>Profit 24,830 WETH is sent to hacker</p></li></ol><p><em>And then to Tornado.</em></p><p><figure><img alt="" src="https://raw.githubusercontent.com/RektHQ/Assets/main/images/2021/03/rekt-linebreak.png"/></figure></p><p><strong>Presumably to avoid suspicion of an inside-job, Publius, the anon behind the protocol, took the decision to reveal their identity as a group of three in a <a href="https://discord.com/channels/880413392916054098/880500642546851850/965496314244775976">statement</a> published to Discord.</strong></p><p>Omniscia is <a href="https://medium.com/@omniscia.io/beanstalk-farms-post-mortem-analysis-a0667ee0ca9d">keen to point out</a> that this attack fell outside the scope of their audit, however their report does include commentary on the <a href="https://omniscia.io/beanstalk-core-protocol/code-style/GovernanceFacet-GFT">governance contract.</a></p><p>Either way, it is surprising that such a vulnerability was not noticed at some point, given that flash loans are <a href="https://www.theblockcrypto.com/post/82721/makerdao-issues-warning-after-a-flash-loan-is-used-to-pass-a-governance-vote">not a novel threat</a> to DeFi governance. A delay on execution of on-chain governance proposals is one way to prevent this.</p><p>This incident might encourage bagholders to monitor governance proposals more carefully.</p><p>However, the average user may expect such <a href="https://twitter.com/phtevenstrong/status/1515682798031548417">heavily</a>-<a href="https://twitter.com/DegenSpartan/status/1515693260546920452?s=20&amp;t=hvmqaVrw6bEMLuOIufPXrQ">shilled</a> projects such as Beanstalk to be under vigilance of more experienced eyes.</p><p><em>DYOR.</em></p><p><figure><img alt="" src="https://raw.githubusercontent.com/RektHQ/Assets/main/images/2021/08/rekt-outline-conc.png"/></figure></p>