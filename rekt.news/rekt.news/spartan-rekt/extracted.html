<section class="post-content"><p><figure><img alt="" src="https://raw.githubusercontent.com/RektHQ/Assets/main/images/2021/05/sparta-header.png"/></figure></p><p><strong>Sparta has fallen.</strong></p><p>A flaw in the code allowed an attacker to drain the SPARTA/WBNB liquidity pool, earning themselves $30.5 million and the 6th position on the rekt leaderboard as a result.</p><p>The attacker took advantage of a flawed logic used to calculate liquidity shares when users burned their LP tokens in order to withdraw funds.</p><p>A flash loan was used to inflate the balance of the pool before burning the same amount of pool tokens, allowing them to claim a much larger amount of underlying assets.</p><p>The following details are taken from the <a href="https://peckshield-94632.medium.com/the-spartan-incident-root-cause-analysis-b14135d3415f">Peckshield</a> root cause analysis.</p><p><figure><img alt="" src="https://raw.githubusercontent.com/RektHQ/Assets/main/images/2021/05/sparta-linebreak.png"/></figure></p><ol><li><p><strong>A flash loan was taken for 10K WBNB, to be returned at the last step with 260 WBNB as the flash loan fee;</strong></p></li><li><p>Swap WBNB to SPARTA five times through the exploited Spartan pool, with each time swapping in 1,913.172376149853767216 WBNB to get 621,865.037751148871481851 SPARTA,</p></li></ol><p>555,430.671213257613862228 SPARTA,</p><p>499,085.759047974016386321 SPARTA,</p><p>450,888.746328171070956525 SPARTA,</p><p>and 409,342.991760515634291439 SPARTA respectively.</p><ol start="3"><li><p><strong>The resulting total 2,536,613.206101067206978364 SPARTA, plus 11,853.332738790033677468 WBNB, are then added into the pool,</strong> minting 933,350.959891510782264802 pool token (SPT1-WBNB);</p></li><li><p><strong>Swap WBNB to SPARTA ten times through the same pool</strong>, with each time swapping in 1,674.025829131122046314 WBNB to get 336,553.226646584413691711 SPARTA,</p></li></ol><p>316,580.407937459884368081 SPARTA,</p><p>298,333.47575083824346321 SPARTA,</p><p>281,619.23694472865873995 SPARTA,</p><p>266,270.782888292437349121 SPARTA,</p><p>252,143.313661963544185874 SPARTA,</p><p>239,110.715943602161587616 SPARTA,</p><p>227,062.743086833745362627 SPARTA,</p><p>215,902.679301559370989883 SPARTA,</p><p>and 205,545.395265586231012643 SPARTA respectively,</p><p>resulting in a total of 2,639,121.977427448690750716 SPARTA.</p><ol start="5"><li><p><strong>Inflate the asset balance in the pool</strong> by transferring into the pool 21,632.147355962694186481 WBNB and all SPARTA from the above step 3, i.e., 2,639,121.977427448690750716 SPARTA.</p></li><li><p><strong>Burn the 933,350.959891510782264802 pool tokens obtained from step 2 to withdraw the liquidity.</strong> Since the pool’s asset balance is inflated, the burn operation leads to 2,538,199.153113548855179986 SPARTA and 20,694.059368262615067224 WBNB.</p></li></ol><blockquote><p>Note that step 2 only deposits 11,853.332738790033677468 WBNB, leading to the profit of about 9K WBNB.</p></blockquote><ol start="7"><li><p><strong>Add the liquidity into the pool with the added assets in step 4</strong> with 1,414,010.159908048805295494 pool token, which is immediately burned to obtain 2,643,882.074112804607308497 SPARTA and 21,555.69728926154636986 WBNB.</p></li><li><p><strong>Repeat the above steps to continue draining funds from the pool.</strong></p></li><li><p><strong>Return the flash loan with 100,260 WBNB.</strong></p></li></ol><p>The vulnerability stems from the fact that the liquidity share calculation calcLiquidityShare() is querying the current balance which can then be inflated for manipulation. A correct calculation needs to make use of cached balance in baseAmountPooled/tokenAmountPooled.</p><p><figure><img alt="" src="https://raw.githubusercontent.com/RektHQ/Assets/main/images/2021/05/sparta-code.png"/></figure></p><p>Most of the attacker’s funds from the above exploitations are currently held in this wallet: <a href="https://bscscan.io/address/0x3b6e77722e2bbe97c1cfa337b42c0939aeb83671">0x3b6e</a>.</p><ul><li>30.7k WBNB ($18.9M)</li><li>4.6M SPARTA ($7.8M at the time of hack)</li><li>1.3M BUSD-T ($1.3)</li><li>23.2 BTCB ($1.3M)</li><li>924k BUSD ($0.9M)</li></ul><p>The attacker used 1inch (to swap all tokens to BTCB or BETH), Spartan (to dump SPARTA), Nerve (to swap BTCB and BETH to Anyswap versions). In this way they were eventually able to withdraw part of the profit through Anyswap.</p><p>Due to slippage, the profit decreased by a third:</p><ul><li>219.5 BTC ($12.4M)</li><li>3311 ETH ($9.7M)</li></ul><p><em>Credit <a href="https://twitter.com/FrankResearcher/status/1388848787632754690?s=20">igor igamberdiev</a></em></p><p><figure><img alt="" src="https://raw.githubusercontent.com/RektHQ/Assets/main/images/2021/05/sparta-linebreak.png"/></figure></p><p><strong>A relatively straightforward story of another copied protocol who were too ambitious with their imitation.</strong></p><p>The era of BSC flash loans is upon us, and this won’t be the last time we see such attacks.</p><p>$30 million reward for only $66 in fees is an excellent ROI, and with so many developers rushing to copy the ETH blue chips onto BSC, there’s sure to be more opportunities for keen eyed hackers.</p><p>With no word yet from CZ or Binance, one wonders, how much of this will they tolerate?</p><p><em>How rekt do you have to get for CZ to step in and save you?</em></p><p><figure><img alt="" src="https://raw.githubusercontent.com/RektHQ/Assets/main/images/2021/03/rekt-text-linebreak.png"/></figure></p>