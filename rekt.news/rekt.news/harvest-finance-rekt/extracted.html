<section class="post-content"><p><figure><img alt="" src="https://raw.githubusercontent.com/RektHQ/Assets/main/images/2020/10/reaper-3.jpg"/></figure>
<strong>The reaper does not listen to the harvest.</strong></p><p>A skilled farmer used<a href="https://etherscan.io/tx/0x9d093325272701d63fdafb0af2d89c7e23eaf18be1a51c580d9bce89987a2dc1/advanced#internal"> flash loans</a> to reap $33.8 million from the FARM_USDT and FARM_USDC pools.</p><p>In troubled times, some turn to sacred texts for guidance.</p><p>Of the ten plagues that ruined the harvests of ancient Egypt, the first brought blood, and the second; frogs.</p><p>It was Baron Rothschild who advised to buy when there’s blood in the streets.</p><p>Now that the heady days of DeFi summer are over, the DFI-PERP has taken on a sanguine liquidity, and the behaviour of the more Enlightened Farmers has become decidedly unchristlike.</p><p>In Exodus 7:25 8-15, we read</p><blockquote><p><em>“I will plague your whole country with frogs. The frogs will go up on you and your people and all your officials.”</em></p></blockquote><p>In our cryptographic metaverse, the developer is the official, and as was prophesied in the ancient scrolls, the Harvest Finance developers have certainly got frogs all up on them.
<figure><img alt="" src="https://lh4.googleusercontent.com/EEKvX8W_B4lZHA9MSaEJA9qThrhZa6rh-AoQOczdOT6lSxVwJ4F9O1tY4uUSdJ0-xuv7VGP9Mo89i63_LF-W-Rqgq28qoytLxTBpggpZeA4pz9ndUb1_jiN7itRThjNxu3MV33PU"/></figure></p><p><strong>Arbitrage Analysis</strong></p><p>fUSDT <a href="https://twitter.com/jiecut42/status/1320574109005348864?s=20">fell 13.7%</a> and $FARM <a href="https://www.coingecko.com/en/coins/harvest-finance">fell 67%</a> over two hours as the hacker took out a $50m USDT flash loan, then used the Curve Finance Y pool to swap funds and stretch stable coin prices out of proportion.</p><p>Detailed transaction analysis <a href="https://ethtx.info/mainnet/0x9d093325272701d63fdafb0af2d89c7e23eaf18be1a51c580d9bce89987a2dc1">here.</a></p><p>The following actions took place in a 7 minute time period. Credit <a href="https://twitter.com/valentinmihov/status/1320667338321154048?s=20">@valentinmihov</a></p><ol><li><p>Swap 11.4m USDC to USDT -&gt; USDT price up</p></li><li><p>Deposit 60.6m USDT into Vault</p></li><li><p>Exchange 11.4m USDT to USDC -&gt; USDT price down</p></li><li><p>Withdraw 61.1m USDT from Vault -&gt; 0.5m profit</p></li><li><p><a href="https://etherscan.io/address/0xf224ab004461540778a914ea397c589b677e27bb">Rinse and repeat 32 times.</a> (without any prior testing)</p></li><li><p><a href="https://app.zerion.io/0x3811765a53c3188c24d412daec3f60faad5f119b/history">Convert to renBTC </a>and exit to BTC / <a href="https://etherscan.io/tx/0x5abe6f9b498471042f6c9f68c63fc3d84398b95a3a9e58c621cee09b3c972879">ETH </a>via Tornado Cash</p></li></ol><p>The attacker was able to withdraw more USDT at step 4 because of the changed USDT price. As the price of USDT was lower during the time of the withdrawal, their shares represent more USDT from the Vault pool.</p><p>Approximately 4 cycles can fit into a 10m gas limit, and although the profit on each cycle is less than 1%, ~$500k per repetition adds up quickly.</p><p>The price calculation mechanism for LP deposits and withdrawals was the source of the exploit, meaning this attack could have carried over to the renBTC pool, the FARM_TUSD pool, and the FARM_DAI pool. However the hacker chose to stop after draining $25m or 17% of what was available in the FARM_USDT and FARM_USDC pools, although they could have easily continued to drain the entire pool for a total of $400m if they had so desired.</p><p>The FARM_USDT strategy has the following code
<figure><img alt="" src="https://lh3.googleusercontent.com/3WZVjYk0XPg_KMkyG8owAtDZUdOPU_PlUaMwHSkl4IYQjAJTeS_yj96Gu0sHTlfukzmqtxdcMUfpVhfmZrAaw05ImW5ceVByqOuEyad2GevtkP0wb_lj_EuqRrI5PB6Su1nCh_vT"/></figure>
Which indicates some price index was calculated.</p><p>However, since they specify "tokenIndex", we can assume they aren't just using get_virtual_price() but instead, do some underlying calculation.
Credit <a href="https://twitter.com/AndreCronjeTech">Andre Cronje</a>
<figure><img alt="" src="https://lh4.googleusercontent.com/RI7-hbXD-8H7Oi3O_mnwPND-Ik4LyPffaqYUX4C9AoT182ohHliSF-9YrArkfQem8CZhY95vlmkTQtIe9ttvxuwBPDSkdI55zYstQzIRThZEXpyFJiScbmtP4pwcHkF2qNvSrph6"/></figure>
The arbitrage check function tolerance value was not high enough, but the default slippage tolerance value of 3% was too high.</p><p><a href="https://twitter.com/PancakeBunnyFin/status/1320615021588537347">Credit PancakeBunnyFin</a></p><p>It wasn’t just the hacker who profited from their actions. LPs and Harvest developers also received a reasonably sized sum of money, as the hacker chose to throw back some scraps ($2,478,549.94) to the Harvest Deployer in the form of USDT and USDC.</p><p>Harvest have since stated that this will be returned to the affected users pro-rata using a snapshot.</p><blockquote><p>No hacker.Just a simple* $24M (0x53f) juicy arb on <a href="https://twitter.com/harvest_finance?ref_src=twsrc%5Etfw">@harvest_finance</a></p><p>$50M USDC flash loan <a href="https://twitter.com/UniswapProtocol?ref_src=twsrc%5Etfw">@UniswapProtocol</a>
Swap $11M (USDC/USDT) <a href="https://twitter.com/CurveFinance?ref_src=twsrc%5Etfw">@CurveFinance</a>
~61M on fUSDT Vault
Swap $11M USDT/USDC yUSDT
Withdraw $61M with $0.5M profit
Repeat &amp; clean into <a href="https://twitter.com/TornadoCash?ref_src=twsrc%5Etfw">@TornadoCash</a> <a href="https://t.co/nFTuyU3s6w">t.co/nFTuyU3s6w</a> <a href="https://t.co/2oXQ2PsY32">pic.twitter.com/2oXQ2PsY32</a> &gt; — Julien Bouteloup (@bneiluj) <a href="https://twitter.com/bneiluj/status/1320686478486347778?ref_src=twsrc%5Etfw">October 26, 2020</a></p></blockquote><p><strong>Lucky Liquidity Providers Profit</strong></p><p>The approximate figures are as follows. <a href="https://twitter.com/jiecut42">Credit Jiecut42</a></p><p>Hacker - $24,000,000</p><p>Uniswap LPs - $6,000,000</p><p>Harvest Developers - $2,500,000</p><p>Curve LPs - $1,000,000</p><p>Ethereum Gas - $100,000</p><p>RenVM fees $20,000</p><p><figure><img alt="" src="https://lh6.googleusercontent.com/O91Z60MeY81zTI2Lu6g3OAAxdJec9tJjcWcY6rbgRPZYW-i8tShq44_XVuhbx2oUao-CsKSqzhPYyHHZRSbvuMrIUwGeOd2npe4Z7KXOox7S_NKK95IEx6ooqh_5MlN8qgtizZu0"/></figure>
Credit <a href="https://twitter.com/BitcoinWhiskers">BitcoinWhiskers</a> for the sweet pie.</p><p>With exposure to all <a href="https://www.curve.fi/">Curve</a> pools, veCRV holders have profited from the extra volume going through Curve, as the hacker generated ~$500k in trading fees which will be shared among all those who are staking their CRV.
Curve trading fees increased over 8,000% from the previous day as the hacker <a href="https://etherscan.io/tx/0xb460b70f11a93364fecf1f3c3ec49f053aecd2d6d9912c012170aa7a0de2d526">swapped </a>over $100M in USDT and USDC.
<figure><img alt="" src="https://lh4.googleusercontent.com/P9kpiXDdXJYtJTO1byo7ylD8Ht4_vJNDbSZZtUcG2MzXflb5VxaW634Su-jKF3W9yNKAeJ49BKnQjiaPBYy3w018NmCpTXJ2bcK9kjniEy6E2hENqHwYk2yJebULie9UzMaFm55m"/></figure><figure><img alt="" src="https://lh4.googleusercontent.com/Az3qJ6dKLbNiXRkUOshi9tgw5Qg0WcRbxF2KhGoxT4GJQ4dOdLT_CpGK6fFkwHHsrnfN0mhcTIZaBdRq-QYWqH7_bCWft16ow-zNO7R0i6YGTBdQGjysjheUKSbZjCJ8V0cyOSws"/></figure>
Uniswap LPs also had a field day thanks to the actions of this anonymous superfarmer.</p><p>Total Uniswap trade volume spiked from $148 million to $1 billion in 24 hours.</p><p>92% of this volume came from the USDT/ETH and USDC/ETH pairs, generating $5.76 million in fees for liquidity providers.</p><p><figure><img alt="" src="https://lh3.googleusercontent.com/fZW3t_eeYeEjsBaluQwSbmHCc2ZP7H5PNBeFUvw0uSxxJqwNs4mL6UvIKWTWGHZ_7rLGpMuveEAzJ_GVLNJbEZOfRi9S8zYV7BWyknpQCgctrsomzLm4Dzbi6qNwuzbzG8gOFGeI"/></figure><figure><img alt="" src="https://lh3.googleusercontent.com/T9IWn6M9JIV_82qkS-t6SC9iSOK6r1TNWO6aBCRerRNaxKXZso62bpGa5vypvVvQaUEfgIcLRkZ5QLoBU3ibErYg4cUDmb7p6CpGjR1NFVQHdtEzXy483uACgcJ-_RQMFfelFO-s"/></figure>
Credit <a href="https://twitter.com/lawmaster/status/1320614508772163584?s=20">Larry Cermak</a></p><p><strong>Confidential Contributor</strong></p><p>Whistleblowing and protecting our contributors is a huge part of what we do at Rekt. While your author was writing this story, someone contacted us with information regarding the actions of Harvest Finance some days prior to last nights events.</p><p>The following information is presented without comment.</p><blockquote><p><em>I was contacted by the Harvest Finance team seeking collaboration on incentivising liquidity pools for two asset classes.</em></p></blockquote><blockquote><p><em>The first was trustless BTC, the second was FARM/ETH.</em></p></blockquote><p><figure><img alt="" src="https://lh5.googleusercontent.com/BI91M7nD8yCLZuJtX0Tpas4RCBD8xnGWl2LrRu4PTbO_CrQUDP2GDuhR45vrUpnOSc-hxuvuKTZ76DT8U58QVgvFxa7CNkQL2KXINn1Hsxw7csVd2b3VYOp8Mhw9_tM-fD58ZFOp"/></figure></p><blockquote><p><em>I didn’t follow up with them as something was off-putting.</em></p></blockquote><blockquote><p><em>I’m not claiming that it is the Harvest team, but seeing the 3% slippage in the smart contract, and the fact that the exploit was in trustless BTC, which is a “novelty”...</em></p></blockquote><blockquote><p><em>I think that if this isn’t Julien, then it has to be Harvest Finance themselves, or the EMN hacker, or someone with deep flashloan knowledge.</em></p></blockquote><p><strong>Refund Requests</strong></p><p>As usual, a debate has arisen regarding the ability for protocols to block or amend this type of activity in the future. In the Curve Telegram group, some were of the opinion that Curve should be able to block this type of activity, however the existing smart contracts <a href="https://twitter.com/CurveFinance/status/1320694100090376193?s=20">cannot be stopped</a> or modified.</p><p>There have also been calls for renBTC to refund the fees they earned from the hackers activity. This is a controversial topic which forces users to consider the pros and cons of using decentralised protocols.</p><p><strong>Sloppy Security</strong></p><p>Only three weeks ago on October 6th, Harvest Finance published a <a href="https://medium.com/harvest-finance/week-6-update-security-rules-everything-around-me-62a681a3692a">security update</a> stating that they were ensuring the safety of their lands via “rigorous security audits” from <a href="https://twitter.com/peckshield">Peckshield</a>, <a href="https://haechi.io/">Haechi Labs</a>, and <a href="https://twitter.com/certik_io">CertiK</a>.</p><p>It should be noted that Peck Shield and CertiK also audited Bzx before their three hacks earlier this year.</p><p>We await their comments on this situation.</p><p>Developers and seemingly even specialised security firms are not used to having to consider the impact of flash loans on their code.</p><p>Mastering flash loans is like turning up to a 12th century jousting tournament on a Harley Davidson dual-wielding AK47’s; nobody expects it, plebs get rekt, and it’s years until the uneducated masses are able to protect themselves from such savage master tradesmen.</p><p>Harvest Finance has responded to the events with an enjoyably passive-aggressive tone.
<figure><img alt="" src="https://lh6.googleusercontent.com/R_kCRELgxVg20qoViEkHb43yiEoWnuslyOQJaPlG0djFHM8FAJEumBYLQP-URiPun5EdcOpKhBOLGHmsi0h36Z6-LdRxFKwD9ABzrFezDcLcNLXtEPBc896I1HcwxfLHCuz5R9IF"/></figure></p><p><a href="https://twitter.com/harvest_finance/status/1320624369543057409">twitter.com/harvest_finance/status/1320624369543057409</a></p><p><figure><img alt="" src="https://lh4.googleusercontent.com/kgpAOlAQRPTcNrx-HJzhDhO04Y9CttjxSfNJ3udyDNvVG5D75NbarZjK3aQ_76axChzA05kmDzDOlSyC9mFX98Odw1U5fSucvIw6zo7JOdjBjANdqm7WN-pac8GzxozyBjZQ6qWK"/></figure>
<strong>Truthful Terminology</strong></p><p>Arbitrage / Exploit / Hack.</p><p>The differences in the terminology become increasingly blurred, while the fact that “code is law” becomes crystal clear.</p><p>The term used by Harvest Finance was arbitrage economic attack. Some consider this activity a crime, while others simply see the actions of a more capable user, yield farming with modern machinery.</p><p>Is this a meritocracy, or anarcho-capitalism?</p><p>It’s certainly entertaining either way.</p><p><em>caveat emptor.</em></p><blockquote><p>It is only the farmer who faithfully plants seeds in the spring, who reaps a Harvest in the autumn.  <a href="https://en.wikipedia.org/wiki/B._C._Forbes">B.C. Forbes</a></p></blockquote>