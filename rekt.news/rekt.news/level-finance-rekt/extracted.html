<section class="post-content"><p><figure><img alt="" src="https://raw.githubusercontent.com/RektHQ/Assets/main/images/2023/01/level-header.png"/></figure></p><p><em><a href="https://twitter.com/Level__Finance">Level Finance</a> got levelled.</em></p><p><strong>Yesterday, $1.1M in referral rewards were robbed from the BSC-based perps platform.</strong></p><p>The alarm was <a href="https://twitter.com/definalist/status/1653110385552289792">raised by definalist</a> (whilst the attack was still ongoing) and <a href="https://twitter.com/Level__Finance/status/1653140756540825638">confirmed</a> two hours later by the Level Finance team.</p><p><strong>Luckily, the losses were contained to the project’s referral programme, with Treasury funds and LP both safe.</strong></p><p>The hacker dumping LVL tokens for BNB initially crashed the price by 65%, though this has mostly recovered since.</p><p>The attack was initially attempted over a week ago, but it seems nobody noticed.</p><p><em>Could a warning have saved Level?</em></p><p><figure><img alt="" src="https://raw.githubusercontent.com/RektHQ/Assets/main/images/2021/09/rekt-investigates-linebreak.png"/></figure></p><p>Credit: <em><a href="https://twitter.com/peckshield/status/1653149493133729794">Peckshield</a>, <a href="https://twitter.com/BlockSecTeam/status/1653267431127920641">BlockSec</a></em></p><p><strong>Level Finance’s LevelReferralControllerV2 contract contained a bug which allowed for repeated referral reward claims to be processed within the same epoch.</strong></p><p>The exploiter prepared the attack by creating many referrals and using flash loans to make swaps, thereby increasing their reward tier.</p><p><strong>The claimMultiple function does not contain a check that the claim’s epoch is not being reused:</strong></p><p><figure><img alt="" src="https://raw.githubusercontent.com/RektHQ/Assets/main/images/2023/01/level-code.png"/></figure></p><p>Exploiter's address: <strong><a href="https://bscscan.com/address/0x70319d1c09e1373fc7b10403c852909e5b20a9d5">0x70319d1c09e1373fc7b10403c852909e5b20a9d5</a></strong></p><p>Example tx: <a href="https://bscscan.com/tx/0xe1f257041872c075cbe6a1212827bc346df3def6d01a07914e4006ec43027165">0xe1f25704…</a></p><p>LevelReferralControllerV2 contract: <a href="https://bscscan.com/address/0x977087422C008233615b572fBC3F209Ed300063a">0x977087422C008233615b572fBC3F209Ed300063a</a></p><p><strong>The project was audited by <a href="https://certificate.quantstamp.com/full/level-finance/929d1708-a464-476d-86f3-7d7942faa4d2/index.html">Quantstamp</a> and <a href="https://obeliskauditing.com/audits/level-finance-core?openPdf=true">Obelisk</a>, who both examined <a href="https://github.com/level-fi/level-core-contracts/blob/master/src/referral/LevelReferralControllerV2.sol">LevelReferralControllerV2</a> as part of the project’s <a href="https://github.com/level-fi/level-core-contracts">Core contracts</a> without spotting the bug.</strong></p><p><strong><em>UPDATE 09/05/2023 - Quantstamp contacted rekt.news stating that the vulnerability was introduced after their audit. They provided the following statement via DM:</em></strong></p><blockquote><p>The vulnerability was included in an upgrade done on April 18 (<a href="https://bscscan.com/tx/0xe0a8e635f4778f6cc935873d8c17a92979eb9adfa77b249dec1d4a15b3e82909">bscscan.com/tx/0xe0a8e635f…</a>) that upgraded the proxy of LevelReferralControllerV2 (<a href="https://bscscan.com/address/0x977087422C008233615b572fBC3F209Ed300063a">bscscan.com/address/0x9770…</a>) to the vulnerable implementation (<a href="https://bscscan.com/address/0x9f00fbd6c095d2c542687ed5afb68d9c3fb2f464#code">bscscan.com/address/0x9f00…</a>).</p><p>This code is different to the commit audited by Quantstamp as stated in the audit report (<a href="https://certificate.quantstamp.com/full/level-finance/929d1708-a464-476d-86f3-7d7942faa4d2/index.html">certificate.quantstamp.com/full/level-fin…</a>). The source code for the vulnerable implementation in question is not committed in the official public repository of Level Finance in GitHub (<a href="https://github.com/level-fi/level-core-contracts">github.com/level-fi/level…</a>).</p></blockquote><p>In total, 214k LVL tokens were drained by the exploiter, who swapped them for 3,345 BNB, worth approximately $1.1M at the time of writing. The funds currently remain in the attacker’s address.</p><p>The sell-off of tokens caused the <a href="https://www.coingecko.com/en/coins/level">LVL price</a> to drop from $8.42 to a low of $2.93 (-65%), though this recovered substantially following the attack.</p><p><figure><img alt="" src="https://raw.githubusercontent.com/RektHQ/Assets/main/images/2021/03/rekt-linebreak.png"/></figure></p><p>As mentioned by <a href="https://twitter.com/BlockSecTeam/status/1653267431127920641">BlockSec</a>, the week that passed between the hacker’s first attempts and their eventual successful exploit demonstrates the potential of on-chain monitoring systems.</p><p>When malicious contracts are created containing code designed to interact with DeFi protocols in unconventional ways, tools like <a href="https://forta.org/">Forta</a>, <a href="https://docs.openzeppelin.com/defender/sentinel">Sentinel</a> and <a href="https://blog.pessimistic.io/spotters-almanac-4c594fd834d1">Spotter</a> are able to recognise the actions as suspicious, and alert teams accordingly.</p><p><em>However, few incidents have so much warning.</em></p><p><strong>DeFi protocols can go from SAFU to rekt from one block to the next.</strong></p><p>Usually, though, an attack contract must be deployed before a hack can be executed. And even a few minutes' warning could be useful for more centralised protocols with the ability to pause contracts.</p><p>If not, though, BlockSec’s own <a href="https://blocksecteam.medium.com/securing-web3-through-proactive-threat-prevention-e9c6e0319531">whitehat frontrunning system</a> has intervened in a number of cases, saving funds and thwarting the efforts of hackers.</p><p><strong>Perhaps a future of on-chain sentinels protecting fully decentralised and self-executing code seems a long way off for now…</strong></p><p><em>…but who knows what the future will bring?</em></p><p><figure><img alt="" src="https://raw.githubusercontent.com/RektHQ/Assets/main/images/2021/08/rekt-outline-conc.png"/></figure></p>