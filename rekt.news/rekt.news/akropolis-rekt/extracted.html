<section class="post-content"><p><figure><img alt="" src="https://raw.githubusercontent.com/RektHQ/Assets/main/images/2020/11/84604-1.jpg"/></figure>
Pericles must be turning in his grave.</p><p>The Akropolis has not been this rekt since the battle of Salamina in 480 B.C.</p><p>A modern day King Xerses has razed the Akropolis once more, stealing $2,000,000 DAI via a combination of flash loans and re-entrancy.</p><p>At first, the Akropolis admins tried to claim they were simply carrying out some “fixes”.
<figure><img alt="" src="https://lh5.googleusercontent.com/MElhS0VhaZ0DA_lMRYeLoRNafz1YWpafkzgdcV_K9F-HNxz1V7H85KDGkQdP3npLM9Nql6LjtEqzKVUnHMdL8OzlWbsZ9JbFl_L7JQJc_MWKJpYwIRr_AVzsBUvrpEtLpc-xpkDi"/></figure>
We now know they were burned for $2 million.
<figure><img alt="" src="https://lh5.googleusercontent.com/OGE_yvAkXzHlE9USnNhS0g0NpV3bqHKBj8Z7bAcVT3B0ejQs8bBkWfWJrmqo_83zWyVTq7aOG_JaLTItr7uL_k2TiKOHN7JEqmwp1T6IOY9w9ENZr6ZtbWE2B29XNxAl4ex_UO_r"/></figure>
But how?</p><p>The Akropolis protocol allows users to deposit tokens into a vault and get different tokens in return. The amount of new tokens you get back depends on how much is deposited.</p><p>The deposit amount is calculated by the difference in balance from before and after the transfer operation.</p><p>Here’s how the attacker took advantage of this system by creating a malicious token contract which called deposit again (reentrancy). <a href="https://etherscan.io/address/0xe2307837524db8961c4541f943598654240bd62f#tokentxns">This</a> is the attack contract.</p><ol><li><p>Create faketoken</p></li><li><p>Deposit faketoken</p></li></ol><p>3a. Get a callback to faketoken, deposit 25k DAI</p><p>3b. Get credited for 25k DAI of deposits</p><ol start="4"><li><p>Get credited for 25k DAI of deposits</p></li><li><p>Withdraw 50k DAI</p></li></ol><p>Credit <a href="https://twitter.com/samczsun">samczsun</a>
<figure><img alt="" src="https://raw.githubusercontent.com/RektHQ/Assets/main/images/2020/11/4d509e7155f551c4d98bb1014b320c61-1.jpg"/></figure>
Because the attacker was able to use their contract as the deposit token, they were able to use reentrance with a dYdx flash loan, as shown below.
<figure><img alt="" src="https://lh4.googleusercontent.com/LxCZ2ZHvBLGPgk7BaoplX3rNuNtfN2JoZ9VeMBZe42MaWMw7ShK_mdgg70RhZJ1DJO4lLn1D8IkAnZ91VKeamI49aW0pDY-7trH07qX2A_ifqbg5xE_1QVLoOxt7qcUBfIYUm8i0"/></figure><figure><img alt="" src="https://lh5.googleusercontent.com/D2wa_EEUSuXUk7r9cRAhX-fwHRv91pmeFeWd1bVR9KFO_IZLXzlzt8I2eJhNfGFP9pOiVokZa58Qn4aFUWlycIIt2gSNNZA5pDSbsy3vqMqsG8eZS1yU8N1qfgQP4_UFbZS0kMfV"/></figure>
<a href="https://etherscan.io/address/0xe2307837524db8961c4541f943598654240bd62f#tokentxns">This</a> is the hackers address. We can see they had started to execute batches of $50k attacks around 8 hours prior.</p><p>They then <a href="https://etherscan.io/tx/0xf15623567231c67df2b8bcc5540236fbda2c3ac11ecbec427048f11b582cb869">sent $2m</a> of these gains to a different address, where it remains at the time of writing.</p><p>Credit <a href="https://twitter.com/Dogetoshi/status/1326963117356625931?s=20">@dogetoshi</a>
<figure><img alt="" src="https://lh3.googleusercontent.com/dSGoJEDMg3SdSHVshM5N8FaLgkai2s1q7gtmCd7-VPKmeNcCew5OXEVAHOQ_Sa9h7iRL021U54658OC8HnVS6MdQSTMxsyjfu6MOKQ-qP5o6Ay0-Jy3NjnVx2dKYEmgAqTrefgjL"/></figure>
We should note that the smart contracts that the hacker interacted with had been audited by two separate security companies, Smartdec and Certik.</p><p>Smartdec have a reasonably good track <a href="https://blog.smartdec.net/">record</a>, however, for Certik, Akropolis is an unwelcome addition to the growing list of projects that they have audited before an exploit.</p><p>bZx, Lien, <a href="/harvest-finance-rekt/">Harvest</a>, and now Akropolis. A completed security audit should never be taken as a guarantee of safety, but a Certik audit certainly carries less weight than it used to...</p><p>Even a well made and thoroughly audited contract can turn into a shit show if in the hands of bad players. The fact that Akropolis were so quick to lie to their users shows that not all the blame lies on Certik or the hacker.</p><p>Although we so often strive for trustless protocols, when it comes to human communication between a user and a service provider, the fragility of trust should always be protected.</p><p>Akropolis have lost that trust, and become rekt.</p>