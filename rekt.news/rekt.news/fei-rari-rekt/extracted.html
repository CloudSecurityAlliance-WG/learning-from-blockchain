<section class="post-content"><p><figure><img alt="" src="https://raw.githubusercontent.com/RektHQ/Assets/main/images/2022/05/fei-rari-header.png"/></figure>
<strong>Fei Rari - rekt.</strong></p><p>Between approximately 9:00 and 9:35 AM UTC on April 30th, seven of <a href="https://twitter.com/feiprotocol/status/1520344430242254849">Rari’s Fuse pools</a> were drained for a total of ~$80M.</p><p>Despite <a href="https://twitter.com/hacxyk/status/1520689345786617856">claiming</a> “<em>none of the arbitrum pools are vulnerable</em>”, the attack <a href="https://twitter.com/RariCapital/status/1520651835081740290">continued</a> on Arbitrum today, though the losses (~100 ETH) were minimal in comparison.</p><p>This isn’t the first time that <a href="https://rekt.news/rari-capital-rekt/">Rari has got rekt</a> - lets hope the hackers don’t go for a hat trick.</p><p><figure><img alt="" src="https://raw.githubusercontent.com/RektHQ/Assets/main/images/2021/09/rekt-investigates-linebreak.png"/></figure></p><p><em>Credit: <a href="https://twitter.com/Hacxyk/status/1520370421773725698">Hacxyk</a>, <a href="https://certik.medium.com/fei-protocol-incident-analysis-8527440696cc">Certik</a></em></p><p><strong>Rari uses forked Compound code, which doesn’t follow the check-effect-interaction pattern, and has led to a number of re-entrancy incidents: <a href="https://rekt.news/cream-rekt/">CREAM</a>, <a href="https://rekt.news/agave-hundred-rekt/">Hundred</a>, <a href="https://rekt.news/voltage-finance-rekt/">Voltage/Ola</a>.</strong></p><p>In this case though, the re-entrancy pattern is via CEther which uses <em>call.value</em> to send ETH. In the case of the receiver being a contract, <em>call.value</em> is able to make another call which can be abused.</p><p>This <a href="https://medium.com/@JackLongarzo/rari-capital-fuse-security-upgrade-report-e5d154c16250">vulnerability</a> was reported in early March and mitigated by upgrading the CToken and Comptroller contracts. However, the new re-entrancy protections didn’t cover the function <em>exitMarket</em> within the Comptroller contract.</p><p><em>exitMarket</em> re-assigns a deposited asset as no longer being collateral, which can then be withdrawn, as long as there is no loan taken against the funds. Given that the checks are made after the transfer (due to Compound code not following check-effect-interaction pattern), the transaction doesn’t record the borrowed amount as debt before the collateral is withdrawn.</p><p>By using flash loans to borrow ETH, the attacker was able to re-enter via <em>call.value</em>, calling <em>exitMarket</em> in order to withdraw the flash loaned collateral whilst also keeping the borrowed ETH.</p><p><figure><img alt="" src="https://raw.githubusercontent.com/RektHQ/Assets/main/images/2022/05/feirari-certik.png"/></figure></p><p><strong><a href="https://certik.medium.com/fei-protocol-incident-analysis-8527440696cc">Step-by-step</a> using example tx <a href="https://etherscan.io/tx/0xab486012f21be741c9e674ffda227e30518e8a1e37a5f1d58d0b0d41f6e76530">0xab4860…</a></strong></p><p><strong>1.</strong> Attacker flashloaned 150,000,000 USDC and 50,000 WETH</p><p><strong>2.</strong> Deposited 150,000,000 USDC as collateral into the fUSDC-127 contract, which is a vulnerable fork version of the compound protocol.</p><p><strong>3.</strong> With deposited collateral, the attacker borrowed 1,977 ETH via the “borrow()” function.</p><p><strong>4.</strong> However, the “borrow()” function does not follow the check-effect-interaction pattern. Specifically, it transfers ETH to the attacker’s contract before updating the attacker’s actual borrow records.</p><p><strong>5.</strong> Therefore, with the attacker’s borrow record not updated, the attacker made a reentrant call to “exitmarket()” in the fallback function, which allows the attacker to withdraw all his collateral (150M USDC)</p><p><strong>6.</strong> The attacker repeated steps 1~5 on multiple other tokens.</p><p><strong>7.</strong> Finally, the attacker repaid the flashloan and transferred the rest to their address as profit, and routed some of the funds onward to Tornado Cash.</p><p><strong>Affected Fuse pools: 8, 18, 27, 127, 144, 146, 156</strong></p><p>Attacker’s address (inc. all exploit txs): <strong><a href="https://etherscan.io/address/0x6162759edad730152f0df8115c698a42e666157f">0x616275…</a></strong></p><p>Attack contracts: <strong><a href="https://etherscan.io/address/0xE39f3C40966DF56c69AA508D8AD459E77B8a2bc1">0xE39f3C…</a>, <a href="https://etherscan.io/address/0x32075bad9050d4767018084f0cb87b3182d36c45">0x32075b…</a></strong></p><p>Arbitrum attack tx: <strong><a href="https://arbiscan.io/tx/0x3212d091792f81f18a31aab753de6b3128d79dcb5e8392167249595f813203ef">0x3212d0…</a></strong></p><p><a href="https://twitter.com/starit1992/status/1520419032805306368">Total funds lost:</a></p><p>6,037.8139071514 eth</p><p>20,251,603.11559831 fei</p><p>14,278,990.684390573 dai</p><p>1,948,952.1788665l lusd</p><p>10,055,556.328173 usdc</p><p>132,959.9008 usdt</p><p>31,615.8714 rai</p><p>13,101,364.94 frax</p><p>2,765,891 ust</p><p><strong>Total estimated value: $79,749,026</strong></p><p>Following the attack, the hacker began depositing the proceeds into Tornado Cash, however stopped after moving just 5400 ETH (~$15M).</p><p>With the remaining $62.7M still in the wallet, is the hacker considering the <a href="https://twitter.com/RariCapital/status/1520505023804891139">offer of a bounty</a> to return the funds?</p><p>Tribe DAO seems to be hopeful, as they sent the following <a href="https://etherscan.io/tx/0xcbe38d148c0c3ebe486d49a3bdf399650be794716390135c0d2f3aa459a4a4cd">message via etherscan.</a></p><blockquote><p>We noticed you may be considering the no-questions-asked $10m offer. If you wish to take us up on this, please deposit the remaining funds to the Tribe DAO Timelock: 0xd51dbA7a94e1adEa403553A8235C302cEbF41a3c</p></blockquote><p><figure><img alt="" src="https://raw.githubusercontent.com/RektHQ/Assets/main/images/2021/03/rekt-linebreak.png"/></figure></p><p>All Compound forks should take this opportunity to check their code for similar vulnerabilities.</p><p>As <a href="https://twitter.com/0x_b1/status/1520488894332026880">0x_b1</a> pointed out:</p><blockquote><p>this exploit had been fixed in Compound code some time ago, but was changed to its previous form in <a href="https://github.com/Rari-Capital/compound-protocol/commit/7acb8df5a5cbf12464b4336663ef7ae6434e62da">this commit</a> by developers</p></blockquote><p>Hopefully the user who asked Rari if the Arbitrum pools were safe was not too badly affected, as they were reassured of their safety by Rari, only to fall victim to the same exploit today.</p><p><strong>A quick check could have prevented the double damage.</strong></p><p><em>Now Rari shares <a href="https://rekt.news/leaderboard/">#10 on the leaderboard.</a></em></p><p><figure><img alt="" src="https://raw.githubusercontent.com/RektHQ/Assets/main/images/2021/08/rekt-outline-conc.png"/></figure></p>