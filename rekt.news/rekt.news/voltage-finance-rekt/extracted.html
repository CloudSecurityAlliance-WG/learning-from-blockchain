<section class="post-content"><p><figure><img alt="" src="https://raw.githubusercontent.com/RektHQ/Assets/main/images/2022/03/voltage-header.png"/></figure></p><p><strong><a href="https://twitter.com/voltfinance/status/1509400356828049413">Voltage Finance</a> has been exploited for ~$4M via its “<em>Lending-as-a-Service</em>” partner <a href="https://twitter.com/ola_finance/status/1509431464521256961">Ola Finance</a> on the Fuse Network.</strong></p><p>Rather than a Compound fork, Ola <a href="https://olafinance.gitbook.io/ola-finance/welcome-to-ola-finance/master">describes itself</a> as a “<em>a technology provider that enables others to build Compound-like instances</em>”.</p><p>Earlier this month, a <a href="https://rekt.news/agave-hundred-rekt/">similar incident</a> on the Gnosis / xDAI chain gave the teams using Compound’s code plenty of warning.</p><p>But somehow, neither Voltage nor Ola got the news.</p><p><em>If only there was somewhere developers could keep up to date with exploits in DeFi…</em></p><p><figure><img alt="" src="https://raw.githubusercontent.com/RektHQ/Assets/main/images/2021/09/rekt-investigates-linebreak.png"/></figure></p><p><strong>Similarly to the cases of <a href="https://rekt.news/agave-hundred-rekt/">Agave DAO and Hundred Finance</a>, this exploit was due to a reentrancy vulnerability in the ERC 677 standard which Fuse Network <a href="https://github.com/fuseio/fuse-bridge/tree/master/native-to-erc20/contracts/contracts">uses</a> for bridged tokens.</strong></p><p>These token types include a <em>callAfterTransfer()</em> function which can be abused to make additional transfers before balances are updated (provided the underlying code does not follow the recommended <em>checks-effects-interactions</em> routine of execution).</p><p>The original Compound code does not follow this pattern, however all proposed collateral tokens are vetted for this vulnerability before being added to the protocol.</p><p><em>Credit: <a href="https://twitter.com/BlockSecTeam/status/1509466576848064512">BlockSecTeam</a></em></p><p>Attacker’s address on Fuse: <a href="https://explorer.fuse.io/address/0x371D7C9e4464576D45f11b27Cf88578983D63d75/transactions">0x371D7C9e4464576D45f11b27Cf88578983D63d75</a></p><p><strong>Example tx (BUSD):</strong> <a href="https://explorer.fuse.io/tx/0x1b3e06b6b310886dfd90a5df8ddbaf515750eda7126cf5f69874e92761b1dc90/token-transfers">0x1b3e06b6b310886dfd90a5df8ddbaf515750eda7126cf5f69874e92761b1dc90</a></p><p><strong>Attacker contract A:</strong> <a href="https://explorer.fuse.io/address/0x632942c9BeF1a1127353E1b99e817651e2390CFF/transactions">0x632942c9BeF1a1127353E1b99e817651e2390CFF</a></p><p><strong>Attacker contract B:</strong> <a href="https://explorer.fuse.io/address/0x9E5b7da68e2aE8aB1835428E6E0c83a7153f6112/internal-transactions">0x9E5b7da68e2aE8aB1835428E6E0c83a7153f6112</a></p><p><strong>1:</strong> Contract A transfers 550 WETH to Contract B</p><p><strong>2:</strong> Contract B deposits 550 WETH, minting 27,284 oWETH</p><p><strong>3:</strong> Contract B borrows 507,216 BUSD</p><p><strong>4:</strong> Contract BUSD calls back to Contract B via <em>callAfterTransfer()</em></p><p><strong>5:</strong> Contract B transfers both 507,216 BUSD and 27,284 oWETH to Contract A.</p><p><strong>6:</strong> Contract A returns 27,284 oWETH to redeem initial deposit of 550 WETH and keeping the 507,216 BUSD as profit.</p><p>As BlockSecTeam <a href="https://twitter.com/BlockSecTeam/status/1509466576848064512">explain:</a></p><blockquote><p>“<em>In the code logic of the borrow() function, the related internal states are updated after an external call. Specifically, the doTransferOut() function will invoke the transfer() function of the ERC677-based token, which will eventually lead to an external call.</em>”</p></blockquote><p><figure><img alt="" src="https://raw.githubusercontent.com/RektHQ/Assets/main/images/2022/03/voltage-code1.png"/></figure></p><p><figure><img alt="" src="https://raw.githubusercontent.com/RektHQ/Assets/main/images/2022/03/voltage-code2.png"/></figure></p><p>The above process was used repeatedly to take $USDC, $FUSD, $WBTC, $WETH &amp; $FUSE.</p><p>The resulting funds were first bridged to <a href="https://etherscan.io/address/0x371d7c9e4464576d45f11b27cf88578983d63d75#tokentxns">Ethereum</a> (originally <a href="https://etherscan.io/tx/0x98c46fc95b196ca35b2acb2e02bb9b6901df6a9a2e356629e9cbb42017a24efb">funded by Tornado Cash</a>) and then sent on to <a href="https://etherscan.io/address/0xbcdb800d77ccaac6597830b026d6af78a1118f42#tokentxns">this address</a>, where they remain in the form of ETH, WBTC, USDC <em>(will Circle freeze these funds?)</em> and FUSE, worth approximately $3.1M.</p><p><figure><img alt="" src="https://raw.githubusercontent.com/RektHQ/Assets/main/images/2021/03/rekt-linebreak.png"/></figure></p><p><strong>When <a href="https://twitter.com/RektHQ/status/1503832693062213642">Agave and Hundred</a> fell victim to the same attack vector, we said;</strong></p><blockquote><p>When one fork falls, all others have to check their foundations.</p></blockquote><p>Voltage Finance didn’t do that, and that’s why they’re taking their place (#64) on <a href="https://rekt.news/leaderboard/">the leaderboard.</a></p><p><figure><img alt="" src="https://raw.githubusercontent.com/RektHQ/Assets/main/images/2021/08/rekt-outline-conc.png"/></figure></p>