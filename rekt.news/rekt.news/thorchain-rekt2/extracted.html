<section class="post-content"><p><figure><img alt="" src="https://raw.githubusercontent.com/RektHQ/Assets/main/images/2021/7/thor2-header.png"/></figure>
<strong>THORChain took a hammering.</strong></p><p>Recently the <a href="https://www.rekt.news/thorchain-rekt/">protocol was hit for $5M.</a></p><p>A second strike saw them lose another $8M.</p><p>The hacker left a clear message for THORChain, but apparently it was not clear enough, as THORChain initially believed they had lost just $800k to a whitehat hacker.</p><p><strong>The tx data told a different story:</strong></p><p><figure><img alt="" src="https://raw.githubusercontent.com/RektHQ/Assets/main/images/2021/7/thor2-hacktxdata.png"/></figure>
<a href="https://twitter.com/defixbt/status/1418338501255335937">Source</a></p><p><strong>THORChain has always used a very conversational tone from their official Twitter account, and they continued to do so even after the attack.</strong></p><p><em>When you’ve lost over 10 million of your users' funds in 10 days, it’s not a good idea to celebrate an increase in followers.</em></p><p><strong>The new followers arrived to watch you bleed, they are not a sign of your success.</strong></p><p>The passion of the THORchain community remains high, but it manifests itself differently now that they are suffering.</p><p>The following message was found in a transaction from a RUNE holder to the attacker.</p><p><figure><img alt="" src="https://raw.githubusercontent.com/RektHQ/Assets/main/images/2021/7/thor2-assdildo.png"/></figure></p><p><strong>“Savage.”</strong></p><p><em>What happened to cause such anger?</em></p><p><figure><img alt="" src="https://raw.githubusercontent.com/RektHQ/Assets/main/images/2021/7/thor-investigates.png"/></figure></p><blockquote><p>Credit: <a href="https://github.com/HalbornSecurity/PublicReports/blob/master/Incident%20Reports/Thorchain_Incident_Analysis_July_23_2021.pdf">Halborn Security</a></p></blockquote><p><strong>The observation of an attack began on the 22.07.2021 - 21:42 GMT</strong></p><p>An attacker targeted the Thorchain Bifrost component through the ETH Router contract.</p><p><figure><img alt="" src="https://raw.githubusercontent.com/RektHQ/Assets/main/images/2021/7/thor2-contract.png"/></figure></p><p><strong>During the transactions, the following addresses are seen in the transactions.</strong></p><p><strong>Router:</strong> <a href="https://etherscan.io/address/0xc145990e84155416144c532e31f89b840ca8c2ce">0xc145990e84155416144c532e31f89b840ca8c2ce</a></p><p><strong>Vault:</strong> <a href="https://etherscan.io/address/0xf56cba49337a624e94042e325ad6bc864436e370">0xf56cba49337a624e94042e325ad6bc864436e370</a></p><p><strong>Attack contract:</strong> <a href="https://etherscan.io/address/0x700196e226283671a3de6704ebcdb37a76658805">0x700196e226283671a3de6704ebcdb37a76658805</a></p><p><strong>Attack wallet (spawned from Tornado Cash):</strong> <a href="https://etherscan.io/address/0x8c1944fac705ef172f21f905b5523ae260f76d62">0x8c1944fac705ef172f21f905b5523ae260f76d62</a></p><blockquote><p>The simple attack steps can be seen below.</p></blockquote><p>The attacker created a fake router (Contract Address), then a deposit event emitted when the attacker sent ETH.</p><p>The attacker passes returnVaultAssets() with a small amount of ETH, but the router is defined as an Asgard vault.</p><p>On the Thorchain Router, it forwarded ETH to the fake Asgard.</p><p>This creates a fake deposit event with a malicious memo.</p><p>Thorchain Bifrost intercepts as a normal deposit and refunds to an attacker due to a bad memo definition.</p><p><a href="https://etherscan.io/address/0x700196e226283671a3de6704ebcdb37a76658805">Contract Address</a></p><p><a href="https://etherscan.io/tx/0x10352e6ec052771a92f05f93e037e066873f64bb502d4488726697987f054595">Transaction 1</a></p><p><a href="https://etherscan.io/tx/0x1c6ef4d5122f1287085097ac37df076d43f389bfc62a1bdfcd3163254b5fe94a">Transaction 2</a></p><p><a href="https://etherscan.io/tx/0x0b39a878f1bf3daa78be149222dd8e5fa3e37b54d0451872b3d7a2cbf7f070e2">Transaction 3</a></p><p><a href="https://etherscan.io/tx/0x01f38f17ba838b54350f8e2a2bd54fcdd9cf3c45fa1d2a735f5311507671be9e">Transaction 4</a></p><p><a href="https://etherscan.io/tx/0xa89d90f300fed8d1d987dec86d0d628f31ffd2d8aefdd857ad90151084531d4c">Transaction 5</a></p><p><a href="https://etherscan.io/tx/0x9db403ad39d3fe78de378af0b49f03d244326662f7fee230db87d12a624f564b">Transaction 6</a></p><p><a href="https://etherscan.io/address/0xd95e6eab231b9f3afa24c31c7050bd84c2982072#tokentxns">Last Transaction By An Attacker</a></p><p><strong>Transactions to THORChain pass user-intent with the MEMO field on the chains which contain custom user input.</strong></p><p>The THORChain inspects the transaction object, as well as the MEMO in order to process the transaction, so care must be taken to ensure the MEMO and the transaction is valid. If not, THORChain will automatically refund. <a href="https://docs.thorchain.org/developers/transaction-memos">(Reference.)</a></p><p>The hacker targeted a refund logic. The attack can be named as Lack of proper multi-event handling.</p><blockquote><p>Impact (~$8M USD)</p></blockquote><p>966.62 <strong>ALCX</strong></p><p>20,866,664.53 <strong>XRUNE</strong></p><p>1,672,794.010 <strong>USDC</strong></p><p>56,104 <strong>SUSHI</strong></p><p>6.91 <strong>YFI</strong></p><p>990,137.46 <strong>USDT</strong></p><p><figure><img alt="" src="https://raw.githubusercontent.com/RektHQ/Assets/main/images/2021/03/rekt-linebreak.png"/></figure></p><p><strong>The price of RUNE <a href="https://www.coingecko.com/en/coins/thorchain">dropped by 25%</a>, however, holders were about to receive more bad news.</strong></p><p>Just as with the previous exploit, a vulnerability present due to decisions actively made by developers was found within the RUNE <a href="https://etherscan.io/token/0x3155ba85d5f96b2d030a4966af206230e46849cb">token contract code.</a></p><p>Hours after the attack, many addresses began to receive a previously unknown token; UniH.</p><p>Those who tried to sell this token had their full RUNE balances drained upon approving its use.</p><p>RUNE’s transferTo function used tx.origin instead of msg.sender, something explicitly advised against within the Solidity documentation as it allows interactions with malicious contracts to move your RUNE.</p><p><figure><img alt="" src="https://raw.githubusercontent.com/RektHQ/Assets/main/images/2021/7/thor2-origintx.png"/></figure></p><p><strong>In this case, granting approval to a protocol to spend UniH was all it took for any RUNE in a wallet to be stolen, as in <a href="https://etherscan.io/tx/0x30588af6b5337d9ea229339287fa230bf307120252ed06018efb7abf85696285">this example.</a></strong></p><p>As can be seen in the code’s comments this was a vulnerability that the team had foreseen, and had been acknowledged as “non-standard”.</p><p><em>Another instance of the THORChain devs leaving instructions for the hackers.</em></p><p>Credit: <a href="https://twitter.com/Mudit__Gupta/status/1418594621622390786?s=20">Mudit Gupta</a></p><p><figure><img alt="" src="https://raw.githubusercontent.com/RektHQ/Assets/main/images/2021/03/rekt-linebreak.png"/></figure></p><p><strong>THORChain rekt again, and they have no one to blame but themselves.</strong></p><p>Although perhaps not a DeFi “blue-chip”, THORChain were a well-established player, and many will be disappointed to see them go downhill so quickly.</p><p><em>Why now, and in such quick succession?</em></p><p>Has something changed internally on the THORChain team, or did they upset somebody who had a motive to hurt them?</p><p>An $8M payday would be enough motive for most, but this anonymous antihero left most of the loot behind…</p><p><strong>This was for power, not wealth.</strong></p><p><em>What’s next for THORChain and their fanatical followers after such a string of major mistakes?</em></p><p><figure><img alt="" src="https://raw.githubusercontent.com/RektHQ/Assets/main/images/2021/04/second-conc2.png"/></figure></p>